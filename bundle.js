"use strict";(()=>{var l=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports);var h=l(d=>{"use strict";Object.defineProperty(d,"__esModule",{value:!0});d.NOTE_DURATION=d.AllNotes=d.NoteNamesFlats=d.NoteNames=d.RootMidiNotes=d.Scale=void 0;var Q;(function(r){r.MAJOR="major",r.MINOR_NATURAL="minor_natural",r.MINOR_HARMONIC="minor_harmonic"})(Q||(d.Scale=Q={}));d.RootMidiNotes={C:{name:"C",midiNumber:48},A:{name:"A",midiNumber:57},D:{name:"D",midiNumber:50},E:{name:"E",midiNumber:52},F:{name:"F",midiNumber:53},G:{name:"G",midiNumber:55},B:{name:"B",midiNumber:59},"C#":{name:"C#",midiNumber:49},"D#":{name:"D#",midiNumber:51},"F#":{name:"F#",midiNumber:54},"G#":{name:"G#",midiNumber:56},"A#":{name:"A#",midiNumber:58},Bb:{name:"Bb",midiNumber:58},Eb:{name:"Eb",midiNumber:51},Ab:{name:"Ab",midiNumber:56},Db:{name:"Db",midiNumber:49},Gb:{name:"Gb",midiNumber:54},Cb:{name:"Cb",midiNumber:59}};d.NoteNames=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];d.NoteNamesFlats=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"];d.AllNotes=["C","G","F","D","Bb","A","Eb","E","Ab","B","Db","F#","Gb","C#","Cb","G#"];d.NOTE_DURATION=.5});var R=l(g=>{"use strict";Object.defineProperty(g,"__esModule",{value:!0});g.areSameNotes=ge;g.normalizePitch=V;g.getBaseOctave=ve;function ge(r,e){return V(r)===V(e)}function V(r){return r%12}function ve(r){return Math.floor(r/12)*12}});var Z=l(b=>{"use strict";Object.defineProperty(b,"__esModule",{value:!0});b.ChordCadenceGenerator=void 0;var E=h(),X=R(),Y={[E.Scale.MAJOR]:[[0,4,7],[0,4,7],[0,4,7]],[E.Scale.MINOR_NATURAL]:[[0,3,7],[0,3,7],[0,3,7]],[E.Scale.MINOR_HARMONIC]:[[0,3,7],[0,3,7],[0,4,7]]},be=[0,5,7,0],B=class{generateCadenceNotes(e,t,i){let s=(0,X.getBaseOctave)(i)-12,n=(a,o)=>{let c=Y[t].length,N=Y[t][o%c].map(Ne=>a+Ne);return[a-12,...N]};return be.map((a,o)=>{let c=(0,X.normalizePitch)(e+a),u=s+c;return n(u,o)})}cadenceToNoteSequence(e,t){let i=[],s=0;for(let n of e){for(let a of n)i.push({pitch:a,startTime:s,endTime:s+t});s+=t}return{notes:i,totalTime:s}}generateCadence(e,t,i,s){let n=this.generateCadenceNotes(e.midiNumber,t,s);return this.cadenceToNoteSequence(n,i)}};b.ChordCadenceGenerator=B});var ee=l(y=>{"use strict";Object.defineProperty(y,"__esModule",{value:!0});y.ChordProgressionService=void 0;var v=h(),ye=[["I","IV","V","I"],["I","vi","IV","V"],["I","V","vi","IV"],["I","IV","vi","V"],["I","V","IV","I"],["I","IV","ii","V"],["I","ii","V","I"]],we=[["i","iv","v","i"],["i","VI","iv","v"],["i","v","VI","iv"],["i","iv","VI","v"],["i","v","iv","i"],["i","iv","ii\xB07","v"],["i","ii\xB07","v","i"]],fe=[["i","iv","V","i"],["i","VI","iv","V"],["i","V","VI","iv"],["i","iv","VI","V"],["i","V","iv","i"],["i","iv","ii\xB07","V"],["i","ii\xB07","V","i"]],_e=[0,2,4,5,7,9,11],Pe=[0,2,3,5,7,8,10],k=class{formatChordName(e,t){if(t.includes("\xB07"))return e+"dim7";if(t.includes("\xB0"))return e+"dim";let i=t.charAt(0);return i===i.toLowerCase()&&i!==i.toUpperCase()?e+"m":e}getScaleDegree(e){switch(e.replace(/Â°(7)?/g,"").toLowerCase()){case"i":return 0;case"ii":return 1;case"iii":return 2;case"iv":return 3;case"v":return 4;case"vi":return 5;case"vii":return 6;default:return 0}}getProgressionForConcreteNote(e,t,i){let s=t===v.Scale.MAJOR?_e:Pe,n=e.map(o=>{let c=this.getScaleDegree(o),u=(i+s[c])%12,N=v.NoteNames[u];return this.formatChordName(N,o)}),a=this.getChordProgressionNotes(s,i);return{chordNames:n,progressionNotes:a}}getChordProgressionNotes(e,t){let i=[];for(let s of e)i.push(t+s);return i}getRandomChordProgression(e){let t=this.getChordProgressions(e),i=Math.floor(Math.random()*t.length);return t[i]}getChordProgressions(e){if(e===v.Scale.MAJOR)return ye;if(e===v.Scale.MINOR_HARMONIC)return fe;if(e===v.Scale.MINOR_NATURAL)return we;throw new Error(`Unsupported scale mode: ${e}`)}generateChordProgression(e,t){let i=this.getRandomChordProgression(e);return this.getProgressionForConcreteNote(i,e,t)}};y.ChordProgressionService=k});var te=l(w=>{"use strict";Object.defineProperty(w,"__esModule",{value:!0});w.DictationsGeneratorService=void 0;var Se=h(),L=Se.NOTE_DURATION,G=class{constructor(){this.rnnImprov=new mm.MusicRNN("https://storage.googleapis.com/magentadata/js/checkpoints/music_rnn/chord_pitches_improv")}init(){this.rnnImprov.initialize()}async generateDictation(e,t){let s=t,n=this.getNotesToImproviseOn(e),a={notes:n,totalTime:n.length*L};console.log(">>>>>",a);let o=mm.sequences.quantizeNoteSequence(a,4),c=e.chordProgression.chordNames;return await this.rnnImprov.continueSequence(o,40,s,c)}getNotesToImproviseOn(e){let t=e.scale,i=t[t.length-1].endTime;for(let s of e.chordProgression.progressionNotes)t.push({pitch:s,startTime:i,endTime:i+L}),i+=L;return t}};w.DictationsGeneratorService=G});var ie=l(f=>{"use strict";Object.defineProperty(f,"__esModule",{value:!0});f.DictationPlayer=void 0;var q=class{constructor(){this.player=new mm.SoundFontPlayer("https://storage.googleapis.com/magentadata/js/soundfonts/sgm_plus"),this.paused=!1}stop(){if(this.player.isPlaying()){this.player.stop();return}}async playCadence(e){this.stop(),await this.player.start(e)}async playDictation(e){this.pausedAtSec=null,this.currentDictation=e,this.stop(),await this.player.start(e),this.paused=!1}async playOneNote(e){this.stop();let t={notes:[{pitch:e.pitch+12,startTime:0,endTime:.6}],totalTime:.6};await this.player.start(t)}pause(){this.player.pause(),this.pausedAtSec=mm.Player.tone.Transport.seconds,this.paused=!0}async resume(){this.currentDictation&&(this.stop(),this.paused=!1,this.player.start(this.currentDictation,void 0,this.pausedAtSec??0))}isPlaying(){return this.player.isPlaying()}isPaused(){return this.paused}};f.DictationPlayer=q});var P=l(_=>{"use strict";Object.defineProperty(_,"__esModule",{value:!0});_.midiPitchToNoteName=Ae;_.getNoteName=ne;var m=h(),Ie=new Set(["F","Bb","Eb","Ab","Db","Gb","Cb"]);function Me(r){return r===m.Scale.MINOR_NATURAL||r===m.Scale.MINOR_HARMONIC}function se(r){switch(r){case"C#":return"Db";case"D#":return"Eb";case"F#":return"Gb";case"G#":return"Ab";case"A#":return"Bb";default:return r}}function De(r){let e=m.NoteNames.indexOf(r);if(e!==-1||(e=m.NoteNamesFlats.indexOf(r),e!==-1))return e;throw new Error(`Unknown note name: ${r}`)}function Ce(r,e){let t=r;if(Me(e)){let n=(De(r)+3)%12,a=m.NoteNames[n];t=se(a)}let i=se(t);return Ie.has(i)||/b/.test(i)}function Ae(r,e,t){let i=ne(r,e,t),s=Math.floor(r/12)-1;return`${i}${s}`}function ne(r,e,t){let i=(r%12+12)%12;return Ce(e,t)?m.NoteNamesFlats[i]:m.NoteNames[i]}});var re=l(I=>{"use strict";Object.defineProperty(I,"__esModule",{value:!0});I.ScaleGeneratorService=void 0;var S=h(),Oe={[S.Scale.MAJOR]:[2,2,1,2,2,2,1],[S.Scale.MINOR_NATURAL]:[2,1,2,2,1,2,2],[S.Scale.MINOR_HARMONIC]:[2,1,2,2,1,3,1]},x=class{generateScale(e){let t=Oe[e.type],i=[],s=e.rootNote.midiNumber,n=s,a=0,o=S.NOTE_DURATION;for(let c=0;c<e.octaves;c++){i.push({pitch:n,startTime:a,endTime:a+o}),a+=o;for(let u=0;u<t.length;u++)n+=t[u],i.push({pitch:n,startTime:a,endTime:a+o}),a+=o;n=s+12*(c+1)}return i}};I.ScaleGeneratorService=x});var ce=l(M=>{"use strict";Object.defineProperty(M,"__esModule",{value:!0});M.AppViewModel=void 0;var Te=Z(),Ve=ee(),ae=h(),j=R(),Re=te(),Ee=ie(),oe=P(),Be=re(),F=class{getGenerationTemperature(){return this.generationTemperature}setGenerationTemperature(e){this.generationTemperature=e}constructor(){this.chordCadenceGenerator=new Te.ChordCadenceGenerator,this.currentCadence={notes:[],totalTime:0},this.currentRevealIndex=0,this.currentNotes=[],this.isPaused=!1,this.cadenceSpeed=.5,this.generationTemperature=.6,this.dictationPlayer=new Ee.DictationPlayer,this.currentDictationParams={rootNote:ae.RootMidiNotes.C,octaves:2,type:ae.Scale.MAJOR},this.dictationsService=new Re.DictationsGeneratorService,this.scaleGenerator=new Be.ScaleGeneratorService,this.chordProgressionService=new Ve.ChordProgressionService,this.dictationsService.init()}getDictationParams(){return this.currentDictationParams}setDictationParams(e){this.currentDictationParams=e}getTargetNoteOrLast(){let e=this.currentNotes;return this.currentSample&&e&&this.currentRevealIndex<e.length?e[this.currentRevealIndex]:e[e.length-1]}hasNoteToDiscover(){return this.currentRevealIndex<this.currentNotes.length}onKeyboardNoteClick(e){let t=this.currentDictationParams,i=this.getTargetNoteOrLast(),s=(0,j.getBaseOctave)(i.pitch),n=(0,j.normalizePitch)(e.pitch),a=s-12+n,o={pitch:a,name:(0,oe.getNoteName)(a,t.rootNote.name,t.type)};this.dictationPlayer.playOneNote(o),this.hasNoteToDiscover()&&((0,j.areSameNotes)(e.pitch,i.pitch)?(this.notesDisplay.revealNoteAt(this.currentRevealIndex,i,t.rootNote,t.type),this.notesDisplay.markCorrectAt(this.currentRevealIndex),this.currentRevealIndex++,this.currentRevealIndex>=this.currentNotes.length&&this.buttonsView.setShowNoteEnabled(!1)):this.notesDisplay.markWrongAt(this.currentRevealIndex))}async startDictation(){this.normalizeTemperature();let e=this.generateDictationData(this.currentDictationParams);this.currentSample=await this.dictationsService.generateDictation(e,this.generationTemperature),this.currentNotes=this.currentSample.notes||[];let t=this.currentNotes?.[0]?.pitch;this.currentCadence=this.chordCadenceGenerator.generateCadence(this.currentDictationParams.rootNote,this.currentDictationParams.type,this.cadenceSpeed,t),this.currentRevealIndex=0,this.dictationParamsView.updateView(this.currentDictationParams),this.notesDisplay.renderPlaceholders(this.currentSample?.notes);let i=this.currentDictationParams.rootNote.midiNumber;this.keyboardView.renderPianoOctave(i),this.buttonsView.setActionsEnabled(!0),this.buttonsView.setShowNoteEnabled(!0),this.buttonsView.setPauseState(!1),await this.playCadence(),await this.sleep(1e3),await this.playDictation()}normalizeTemperature(){let i=Math.max(.1,Math.min(1.5,this.generationTemperature));i!==this.generationTemperature&&(this.generationTemperature=i,this.selectorsView?.syncFromParams())}generateDictationData(e){let t=this.scaleGenerator.generateScale(e);return{chordProgression:this.chordProgressionService.generateChordProgression(e.type,e.rootNote.midiNumber),scale:t}}sleep(e){return new Promise(t=>setTimeout(t,e))}async playDictation(){this.currentSample&&(this.isPaused=!1,this.buttonsView.setPauseState(!1),await this.dictationPlayer.playDictation(this.currentSample))}async playCadence(){this.currentCadence&&await this.dictationPlayer.playCadence(this.currentCadence)}getOneOctaveScale(e){return this.scaleGenerator.generateScale({...e,octaves:1}).map(i=>({pitch:i.pitch,name:(0,oe.getNoteName)(i.pitch,this.currentDictationParams.rootNote.name,this.currentDictationParams.type)}))}initViewInteractions(e,t,i,s,n){this.notesDisplay=e,this.dictationParamsView=t,this.keyboardView=i,this.buttonsView=s,this.selectorsView=n}async togglePause(){this.isPaused=!this.isPaused,this.buttonsView.setPauseState(this.isPaused),this.isPaused?this.dictationPlayer.pause():await this.dictationPlayer.resume()}revealNextNote(){if(!this.currentSample||!this.currentSample.notes)return;let e=this.currentSample.notes;if(this.currentRevealIndex>=e.length){this.buttonsView.setShowNoteEnabled(!1);return}let t=this.currentRevealIndex,i=e[t];this.notesDisplay.revealNoteAt(t,i,this.currentDictationParams.rootNote,this.currentDictationParams.type),this.currentRevealIndex++,this.currentRevealIndex>=e.length&&this.buttonsView.setShowNoteEnabled(!1)}};M.AppViewModel=F});var le=l(D=>{"use strict";Object.defineProperty(D,"__esModule",{value:!0});D.ButtonsView=void 0;var H=class{constructor(e){this.startBtn=document.getElementById("start"),this.playDictationBtn=document.getElementById("play-dictation"),this.playCadenceBtn=document.getElementById("play-cadence"),this.pauseDictationBtn=document.getElementById("pause-dictation"),this.appViewModel=e,this.showNoteBtn=document.getElementById("show-note"),this.setupEventListeners()}setupEventListeners(){this.startBtn?.addEventListener("click",async()=>{this.setStartEnabled(!1);try{await this.appViewModel.startDictation()}finally{this.setStartEnabled(!0)}}),this.playDictationBtn?.addEventListener("click",async()=>await this.appViewModel.playDictation()),this.playCadenceBtn?.addEventListener("click",async()=>await this.appViewModel.playCadence()),this.showNoteBtn?.addEventListener("click",()=>this.appViewModel.revealNextNote()),this.pauseDictationBtn?.addEventListener("click",()=>this.appViewModel.togglePause())}setActionsEnabled(e){this.playDictationBtn&&(this.playDictationBtn.disabled=!e,this.playDictationBtn.setAttribute("aria-disabled",String(!e))),this.playCadenceBtn&&(this.playCadenceBtn.disabled=!e,this.playCadenceBtn.setAttribute("aria-disabled",String(!e))),this.pauseDictationBtn&&(this.pauseDictationBtn.disabled=!e,this.pauseDictationBtn.setAttribute("aria-disabled",String(!e))),this.showNoteBtn&&(this.showNoteBtn.disabled=!e,this.showNoteBtn.setAttribute("aria-disabled",String(!e)))}setStartEnabled(e){this.startBtn.disabled=!e,this.startBtn.setAttribute("aria-disabled",String(!e))}setShowNoteEnabled(e){this.showNoteBtn&&(this.showNoteBtn.disabled=!e,this.showNoteBtn.setAttribute("aria-disabled",String(!e)))}setPauseState(e){this.pauseDictationBtn&&(this.pauseDictationBtn.textContent=e?"Resume":"Pause",this.pauseDictationBtn.setAttribute("aria-pressed",String(e)))}};D.ButtonsView=H});var ue=l(C=>{"use strict";Object.defineProperty(C,"__esModule",{value:!0});C.DictationParamsView=void 0;var $=h(),U=class{constructor(){this.dictationParamsSection=document.getElementById("dictation-params-section"),this.dictationParamsDiv=document.getElementById("dictation-params")}convertType(e){switch(e){case $.Scale.MAJOR:return"Major";case $.Scale.MINOR_NATURAL:return"Natural Minor";case $.Scale.MINOR_HARMONIC:return"Harmonic Minor";default:return"Unknown"}}updateView(e){this.dictationParamsDiv&&(this.dictationParamsDiv.innerHTML=`
            <p><strong>Scale:</strong> <span>${e.rootNote.name} ${this.convertType(e.type)}</span></p>
        `,this.dictationParamsSection.style.display="block")}};C.DictationParamsView=U});var de=l(A=>{"use strict";Object.defineProperty(A,"__esModule",{value:!0});A.KeyboardView=void 0;var ke=P(),Le="keyboard",z=class{constructor(e){this.container=document.getElementById(Le),this.appViewModel=e}renderScale(e){if(this.container){this.container.innerHTML="";for(let t of e){let i=t.pitch,s=t.name,n=document.createElement("button");n.className="key-btn btn",n.type="button",n.setAttribute("data-pitch",String(i)),n.setAttribute("aria-label",`${s} (${i})`),n.textContent=s,n.addEventListener("click",()=>this.onClick({pitch:i,name:s})),this.container.appendChild(n)}}}renderPianoOctave(e){if(!this.container)return;this.container.innerHTML="";let t=this.appViewModel.getDictationParams(),i=document.createElement("div");i.className="kb-row kb-row--black";let s=document.createElement("div");s.className="kb-row kb-row--white";let n=o=>[0,2,4,5,7,9,11].includes(o),a=[];for(let o=e;o<=e+12;o++){let c=(o%12+12)%12;if(n(c)&&a.push({pitch:o,pc:c}),a.length===8)break}a.forEach((o,c)=>{let u=this.makeKeyButton(o.pitch,t.rootNote.name,t.type,!1);u.style.gridColumn=`${c*2+1} / span 2`,s.appendChild(u)});for(let o=0;o<a.length-1;o++){let c=a[o];if(c.pc===4||c.pc===11)continue;let u=c.pitch+1;if(u>=e+12)continue;let N=this.makeKeyButton(u,t.rootNote.name,t.type,!0);N.style.gridColumn=`${o*2+2} / span 2`,i.appendChild(N)}this.container.appendChild(i),this.container.appendChild(s)}makeKeyButton(e,t,i,s){let n=(0,ke.getNoteName)(e,t,i),a=document.createElement("button");return a.className=`key-btn btn ${s?"key--black":"key--white"}`,a.type="button",a.setAttribute("data-pitch",String(e)),a.setAttribute("aria-label",`${n} (${e})`),a.textContent=n,a.addEventListener("click",()=>this.onClick({pitch:e,name:n})),a}onClick(e){this.appViewModel.onKeyboardNoteClick(e)}};A.KeyboardView=z});var he=l(O=>{"use strict";Object.defineProperty(O,"__esModule",{value:!0});O.NotesView=void 0;var Ge=P(),J=class{constructor(){this.placeholdersEl=document.getElementById("placeholders")}renderPlaceholders(e){let t=Array.from({length:e.length},()=>"<li>?</li>").join("");this.placeholdersEl.innerHTML=t}revealNoteAt(e,t,i,s){let n=this.placeholdersEl.children.item(e);n.textContent=(0,Ge.midiPitchToNoteName)(t.pitch,i.name,s),n.classList.remove("note--wrong"),n.classList.add("note--correct")}markCorrectAt(e){let t=this.placeholdersEl.children.item(e);t.classList.remove("note--wrong"),t.classList.add("note--correct")}markWrongAt(e){let t=this.placeholdersEl.children.item(e);t.classList.remove("note--correct"),t.classList.add("note--wrong")}};O.NotesView=J});var pe=l(T=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0});T.SelectorsView=void 0;var p=h(),K=class{constructor(e){this.app=e,this.rootSelect=document.getElementById("root-select"),this.scaleSelect=document.getElementById("scale-select"),this.temperatureInput=document.getElementById("generation-temperature"),this.renderOptions(),this.setupEventHandlers(),this.syncFromParams()}renderOptions(){this.rootSelect.innerHTML=p.AllNotes.map(t=>`<option value="${t}">${t}</option>`).join("");let e=[p.Scale.MAJOR,p.Scale.MINOR_NATURAL,p.Scale.MINOR_HARMONIC];this.scaleSelect.innerHTML=e.map(t=>`<option value="${t}">${this.prettyScaleLabel(t)}</option>`).join("")}prettyScaleLabel(e){switch(e){case p.Scale.MAJOR:return"Major";case p.Scale.MINOR_NATURAL:return"Natural Minor";case p.Scale.MINOR_HARMONIC:return"Harmonic Minor";default:return String(e)}}setupEventHandlers(){this.rootSelect.addEventListener("change",()=>this.applyToModel()),this.scaleSelect.addEventListener("change",()=>this.applyToModel()),this.temperatureInput.addEventListener("change",()=>this.applyToModel())}syncFromParams(){let e=this.app.getDictationParams();this.rootSelect.value=e.rootNote.name,this.scaleSelect.value=e.type,this.temperatureInput.value=String(this.app.getGenerationTemperature?.()??.6)}applyToModel(){let e=this.app.getDictationParams(),t=this.rootSelect.value,i=this.scaleSelect.value,s={...e,rootNote:p.RootMidiNotes[t],type:i};this.app.setDictationParams(s);let n=parseFloat(this.temperatureInput.value);isNaN(n)||this.app.setGenerationTemperature?.(n)}};T.SelectorsView=K});var Ue=l(me=>{Object.defineProperty(me,"__esModule",{value:!0});var qe=ce(),xe=le(),je=ue(),Fe=de(),He=he(),$e=pe(),W=class{constructor(){this.appViewModel=new qe.AppViewModel;let e=new He.NotesView,t=new je.DictationParamsView,i=new Fe.KeyboardView(this.appViewModel),s=new xe.ButtonsView(this.appViewModel),n=new $e.SelectorsView(this.appViewModel);this.appViewModel.initViewInteractions(e,t,i,s,n)}};document.addEventListener("DOMContentLoaded",()=>{new W})});Ue();})();
