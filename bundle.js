"use strict";(()=>{var N={C:{name:"C",midiNumber:48},A:{name:"A",midiNumber:57},D:{name:"D",midiNumber:50},E:{name:"E",midiNumber:52},F:{name:"F",midiNumber:53},G:{name:"G",midiNumber:55},B:{name:"B",midiNumber:59},"C#":{name:"C#",midiNumber:49},"D#":{name:"D#",midiNumber:51},"F#":{name:"F#",midiNumber:54},"G#":{name:"G#",midiNumber:56},"A#":{name:"A#",midiNumber:58},Bb:{name:"Bb",midiNumber:58},Eb:{name:"Eb",midiNumber:51},Ab:{name:"Ab",midiNumber:56},Db:{name:"Db",midiNumber:49},Gb:{name:"Gb",midiNumber:54},Cb:{name:"Cb",midiNumber:59}},p=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],E=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"],R=["C","G","F","D","Bb","A","Eb","E","Ab","B","Db","F#","Gb","C#","Cb","G#"],b=.5;function L(o,t){return u(o)===u(t)}function u(o){return o%12}function g(o){return Math.floor(o/12)*12}var O={major:[[0,4,7],[0,4,7],[0,4,7]],minor_natural:[[0,3,7],[0,3,7],[0,3,7]],minor_harmonic:[[0,3,7],[0,3,7],[0,4,7]]},G=[0,5,7,0],v=class{generateCadenceNotes(t,e,i){let r=g(i)-12,a=(n,s)=>{let c=O[e].length,l=O[e][s%c].map(k=>n+k);return[n-12,...l]};return G.map((n,s)=>{let c=u(t+n),m=r+c;return a(m,s)})}cadenceToNoteSequence(t,e){let i=[],r=0;for(let a of t){for(let n of a)i.push({pitch:n,startTime:r,endTime:r+e});r+=e}return{notes:i,totalTime:r}}generateCadence(t,e,i,r){let a=this.generateCadenceNotes(t.midiNumber,e,r);return this.cadenceToNoteSequence(a,i)}};var _=[["I","IV","V","I"],["I","vi","IV","V"],["I","V","vi","IV"],["I","IV","vi","V"],["I","V","IV","I"],["I","IV","ii","V"],["I","ii","V","I"]],F=[["i","iv","v","i"],["i","VI","iv","v"],["i","v","VI","iv"],["i","iv","VI","v"],["i","v","iv","i"],["i","iv","ii\xB07","v"],["i","ii\xB07","v","i"]],K=[["i","iv","V","i"],["i","VI","iv","V"],["i","V","VI","iv"],["i","iv","VI","V"],["i","V","iv","i"],["i","iv","ii\xB07","V"],["i","ii\xB07","V","i"]],$=[0,2,4,5,7,9,11],q=[0,2,3,5,7,8,10],y=class{formatChordName(t,e){if(e.includes("\xB07"))return t+"dim7";if(e.includes("\xB0"))return t+"dim";let i=e.charAt(0);return i===i.toLowerCase()&&i!==i.toUpperCase()?t+"m":t}getScaleDegree(t){switch(t.replace(/Â°(7)?/g,"").toLowerCase()){case"i":return 0;case"ii":return 1;case"iii":return 2;case"iv":return 3;case"v":return 4;case"vi":return 5;case"vii":return 6;default:return 0}}getProgressionForConcreteNote(t,e,i){let r=e==="major"?$:q,a=t.map(s=>{let c=this.getScaleDegree(s),m=(i+r[c])%12,l=p[m];return this.formatChordName(l,s)}),n=this.getChordProgressionNotes(r,i);return{chordNames:a,progressionNotes:n}}getChordProgressionNotes(t,e){let i=[];for(let r of t)i.push(e+r);return i}getRandomChordProgression(t){let e=this.getChordProgressions(t),i=Math.floor(Math.random()*e.length);return e[i]}getChordProgressions(t){if(t==="major")return _;if(t==="minor_harmonic")return K;if(t==="minor_natural")return F;throw new Error(`Unsupported scale mode: ${t}`)}generateChordProgression(t,e){let i=this.getRandomChordProgression(t);return this.getProgressionForConcreteNote(i,t,e)}};var A=b,D=class{constructor(){this.rnnImprov=new mm.MusicRNN("https://storage.googleapis.com/magentadata/js/checkpoints/music_rnn/chord_pitches_improv")}init(){this.rnnImprov.initialize()}async generateDictation(t,e){let r=e,a=this.getNotesToImproviseOn(t),n={notes:a,totalTime:a.length*A},s=mm.sequences.quantizeNoteSequence(n,4),c=t.chordProgression.chordNames;return await this.rnnImprov.continueSequence(s,40,r,c)}getNotesToImproviseOn(t){let e=t.scale,i=e[e.length-1].endTime;for(let r of t.chordProgression.progressionNotes)e.push({pitch:r,startTime:i,endTime:i+A}),i+=A;return e}};var f=class{constructor(){this.player=new mm.SoundFontPlayer("https://storage.googleapis.com/magentadata/js/soundfonts/sgm_plus");this.paused=!1}stop(){if(this.player.isPlaying()){this.player.stop();return}}async playCadence(t){this.stop(),await this.player.start(t)}async playDictation(t){this.pausedAtSec=null,this.currentDictation=t,this.stop(),await this.player.start(t),this.paused=!1}async playOneNote(t){this.stop();let e={notes:[{pitch:t.pitch+12,startTime:0,endTime:.6}],totalTime:.6};await this.player.start(e)}pause(){this.player.pause(),this.pausedAtSec=mm.Player.tone.Transport.seconds,this.paused=!0}async resume(){this.currentDictation&&(this.stop(),this.paused=!1,this.player.start(this.currentDictation,void 0,this.pausedAtSec??0))}isPlaying(){return this.player.isPlaying()}isPaused(){return this.paused}};var U=new Set(["F","Bb","Eb","Ab","Db","Gb","Cb"]);function j(o){return o==="minor_natural"||o==="minor_harmonic"}function x(o){switch(o){case"C#":return"Db";case"D#":return"Eb";case"F#":return"Gb";case"G#":return"Ab";case"A#":return"Bb";default:return o}}function J(o){let t=p.indexOf(o);if(t!==-1||(t=E.indexOf(o),t!==-1))return t;throw new Error(`Unknown note name: ${o}`)}function z(o,t){let e=o;if(j(t)){let a=(J(o)+3)%12,n=p[a];e=x(n)}let i=x(e);return U.has(i)||/b/.test(i)}function H(o,t,e){let i=h(o,t,e),r=Math.floor(o/12)-1;return`${i}${r}`}function h(o,t,e){let i=(o%12+12)%12;return z(t,e)?E[i]:p[i]}var w=class{constructor(){this.storageKey="dictationParams"}getDictationParams(){try{let t=localStorage.getItem(this.storageKey);if(t)return JSON.parse(t)}catch(t){console.error("Error loading dictation params from localStorage",t)}return null}setDictationParams(t){try{localStorage.setItem(this.storageKey,JSON.stringify(t))}catch(e){console.error("Error saving dictation params to localStorage",e)}}};var W={major:[2,2,1,2,2,2,1],minor_natural:[2,1,2,2,1,2,2],minor_harmonic:[2,1,2,2,1,3,1]},M=class{generateScale(t){let e=W[t.type],i=[],r=t.rootNote.midiNumber,a=r,n=0,s=b;for(let c=0;c<t.octaves;c++){i.push({pitch:a,startTime:n,endTime:n+s}),n+=s;for(let m=0;m<e.length;m++)a+=e[m],i.push({pitch:a,startTime:n,endTime:n+s}),n+=s;a=r+12*(c+1)}return i}};var P=class{constructor(){this.localStorageService=new w;this.chordCadenceGenerator=new v;this.currentCadence={notes:[],totalTime:0};this.currentRevealIndex=0;this.currentNotes=[];this.isPaused=!1;this.cadenceSpeed=.5;this.dictationPlayer=new f,this.currentDictationParams=this.localStorageService.getDictationParams()??this.getDefaultDictationParams(),this.dictationsService=new D,this.scaleGenerator=new M,this.chordProgressionService=new y,this.dictationsService.init()}getDefaultDictationParams(){return{rootNote:N.C,octaves:2,type:"major",generationTemperature:1}}getDictationParams(){return this.currentDictationParams}setDictationParams(t){this.currentDictationParams=t,this.localStorageService.setDictationParams(this.currentDictationParams)}getTargetNoteOrLast(){let t=this.currentNotes;return this.currentSample&&t&&this.currentRevealIndex<t.length?t[this.currentRevealIndex]:t[t.length-1]}hasNoteToDiscover(){return this.currentRevealIndex<this.currentNotes.length}onKeyboardNoteClick(t){let e=this.currentDictationParams,i=this.getTargetNoteOrLast(),r=g(i.pitch),a=u(t.pitch),n=r-12+a,s={pitch:n,name:h(n,e.rootNote.name,e.type)};this.dictationPlayer.playOneNote(s),this.hasNoteToDiscover()&&(L(t.pitch,i.pitch)?(this.notesDisplay.revealNoteAt(this.currentRevealIndex,i,e.rootNote,e.type),this.notesDisplay.markCorrectAt(this.currentRevealIndex),this.currentRevealIndex++,this.currentRevealIndex>=this.currentNotes.length&&this.buttonsView.setShowNoteEnabled(!1)):this.notesDisplay.markWrongAt(this.currentRevealIndex))}async prepareDictation(){this.normalizeTemperature();let t=this.generateDictationData(this.currentDictationParams);this.currentSample=await this.dictationsService.generateDictation(t,this.currentDictationParams.generationTemperature),this.currentNotes=this.currentSample.notes||[];let e=this.currentNotes?.[0]?.pitch;this.currentCadence=this.chordCadenceGenerator.generateCadence(this.currentDictationParams.rootNote,this.currentDictationParams.type,this.cadenceSpeed,e),this.currentRevealIndex=0,this.dictationParamsView.updateView(this.currentDictationParams),this.notesDisplay.renderPlaceholders(this.currentSample?.notes);let i=this.currentDictationParams.rootNote.midiNumber;this.keyboardView.renderPianoOctave(i),this.buttonsView.setActionsEnabled(!0),this.buttonsView.setShowNoteEnabled(!0),this.buttonsView.setPauseState(!1)}async playCadenceWithDictation(){await this.playCadence(),await this.sleep(1e3),await this.playDictation()}normalizeTemperature(){let i=Math.max(.1,Math.min(1.5,this.currentDictationParams.generationTemperature));i!==this.currentDictationParams.generationTemperature&&(this.currentDictationParams.generationTemperature=i,this.selectorsView?.syncFromParams())}setGenerationTemperature(t){this.currentDictationParams.generationTemperature=t}generateDictationData(t){let e=this.scaleGenerator.generateScale(t);return{chordProgression:this.chordProgressionService.generateChordProgression(t.type,t.rootNote.midiNumber),scale:e}}sleep(t){return new Promise(e=>setTimeout(e,t))}async playDictation(){this.currentSample&&(this.isPaused=!1,this.buttonsView.setPauseState(!1),await this.dictationPlayer.playDictation(this.currentSample))}async playCadence(){this.currentCadence&&await this.dictationPlayer.playCadence(this.currentCadence)}getOneOctaveScale(t){return this.scaleGenerator.generateScale({...t,octaves:1}).map(i=>({pitch:i.pitch,name:h(i.pitch,this.currentDictationParams.rootNote.name,this.currentDictationParams.type)}))}initViewInteractions(t,e,i,r,a){this.notesDisplay=t,this.dictationParamsView=e,this.keyboardView=i,this.buttonsView=r,this.selectorsView=a}async togglePause(){this.isPaused=!this.isPaused,this.buttonsView.setPauseState(this.isPaused),this.isPaused?this.dictationPlayer.pause():await this.dictationPlayer.resume()}revealNextNote(){if(!this.currentSample||!this.currentSample.notes)return;let t=this.currentSample.notes;if(this.currentRevealIndex>=t.length){this.buttonsView.setShowNoteEnabled(!1);return}let e=this.currentRevealIndex,i=t[e];this.notesDisplay.revealNoteAt(e,i,this.currentDictationParams.rootNote,this.currentDictationParams.type),this.currentRevealIndex++,this.currentRevealIndex>=t.length&&this.buttonsView.setShowNoteEnabled(!1)}};var S=class{constructor(t){this.startBtn=document.getElementById("start"),this.playDictationBtn=document.getElementById("play-dictation"),this.playCadenceBtn=document.getElementById("play-cadence"),this.pauseDictationBtn=document.getElementById("pause-dictation"),this.appViewModel=t,this.showNoteBtn=document.getElementById("show-note"),this.setupEventListeners()}setupEventListeners(){this.startBtn?.addEventListener("click",async()=>{try{this.setStartEnabled(!1),await this.appViewModel.prepareDictation()}finally{this.setStartEnabled(!0)}await this.appViewModel.playCadenceWithDictation()}),this.playDictationBtn?.addEventListener("click",async()=>await this.appViewModel.playDictation()),this.playCadenceBtn?.addEventListener("click",async()=>await this.appViewModel.playCadence()),this.showNoteBtn?.addEventListener("click",()=>this.appViewModel.revealNextNote()),this.pauseDictationBtn?.addEventListener("click",()=>this.appViewModel.togglePause())}setActionsEnabled(t){this.playDictationBtn&&(this.playDictationBtn.disabled=!t,this.playDictationBtn.setAttribute("aria-disabled",String(!t))),this.playCadenceBtn&&(this.playCadenceBtn.disabled=!t,this.playCadenceBtn.setAttribute("aria-disabled",String(!t))),this.pauseDictationBtn&&(this.pauseDictationBtn.disabled=!t,this.pauseDictationBtn.setAttribute("aria-disabled",String(!t))),this.showNoteBtn&&(this.showNoteBtn.disabled=!t,this.showNoteBtn.setAttribute("aria-disabled",String(!t)))}setStartEnabled(t){this.startBtn.disabled=!t,this.startBtn.setAttribute("aria-disabled",String(!t))}setShowNoteEnabled(t){this.showNoteBtn&&(this.showNoteBtn.disabled=!t,this.showNoteBtn.setAttribute("aria-disabled",String(!t)))}setPauseState(t){this.pauseDictationBtn&&(this.pauseDictationBtn.textContent=t?"Resume":"Pause",this.pauseDictationBtn.setAttribute("aria-pressed",String(t)))}};var T=class{constructor(){this.dictationParamsSection=document.getElementById("dictation-params-section"),this.dictationParamsDiv=document.getElementById("dictation-params")}convertType(t){switch(t){case"major":return"Major";case"minor_natural":return"Natural Minor";case"minor_harmonic":return"Harmonic Minor";default:return"Unknown"}}updateView(t){this.dictationParamsDiv&&(this.dictationParamsDiv.innerHTML=`
            <p><strong>Scale:</strong> <span>${t.rootNote.name} ${this.convertType(t.type)}</span></p>
        `,this.dictationParamsSection.style.display="block")}};var Q="keyboard",I=class{constructor(t){this.container=document.getElementById(Q),this.appViewModel=t}renderScale(t){if(this.container){this.container.innerHTML="";for(let e of t){let i=e.pitch,r=e.name,a=document.createElement("button");a.className="key-btn btn",a.type="button",a.setAttribute("data-pitch",String(i)),a.setAttribute("aria-label",`${r} (${i})`),a.textContent=r,a.addEventListener("click",()=>this.onClick({pitch:i,name:r})),this.container.appendChild(a)}}}renderPianoOctave(t){if(!this.container)return;this.container.innerHTML="";let e=this.appViewModel.getDictationParams(),i=document.createElement("div");i.className="kb-row kb-row--black";let r=document.createElement("div");r.className="kb-row kb-row--white";let a=s=>[0,2,4,5,7,9,11].includes(s),n=[];for(let s=t;s<=t+12;s++){let c=(s%12+12)%12;if(a(c)&&n.push({pitch:s,pc:c}),n.length===8)break}n.forEach((s,c)=>{let m=this.makeKeyButton(s.pitch,e.rootNote.name,e.type,!1);m.style.gridColumn=`${c*2+1} / span 2`,r.appendChild(m)});for(let s=0;s<n.length-1;s++){let c=n[s];if(c.pc===4||c.pc===11)continue;let m=c.pitch+1;if(m>=t+12)continue;let l=this.makeKeyButton(m,e.rootNote.name,e.type,!0);l.style.gridColumn=`${s*2+2} / span 2`,i.appendChild(l)}this.container.appendChild(i),this.container.appendChild(r)}makeKeyButton(t,e,i,r){let a=h(t,e,i),n=document.createElement("button");return n.className=`key-btn btn ${r?"key--black":"key--white"}`,n.type="button",n.setAttribute("data-pitch",String(t)),n.setAttribute("aria-label",`${a} (${t})`),n.textContent=a,n.addEventListener("click",()=>this.onClick({pitch:t,name:a})),n}onClick(t){this.appViewModel.onKeyboardNoteClick(t)}};var V=class{constructor(){this.placeholdersEl=document.getElementById("placeholders")}renderPlaceholders(t){let e=Array.from({length:t.length},()=>"<li>?</li>").join("");this.placeholdersEl.innerHTML=e}revealNoteAt(t,e,i,r){let a=this.placeholdersEl.children.item(t);a.textContent=H(e.pitch,i.name,r),a.classList.remove("note--wrong"),a.classList.add("note--correct")}markCorrectAt(t){let e=this.placeholdersEl.children.item(t);e.classList.remove("note--wrong"),e.classList.add("note--correct")}markWrongAt(t){let e=this.placeholdersEl.children.item(t);e.classList.remove("note--correct"),e.classList.add("note--wrong")}};var C=class{constructor(t){this.app=t,this.rootSelect=document.getElementById("root-select"),this.scaleSelect=document.getElementById("scale-select"),this.temperatureInput=document.getElementById("generation-temperature"),this.renderOptions(),this.setupEventHandlers(),this.syncFromParams()}renderOptions(){this.rootSelect.innerHTML=R.map(e=>`<option value="${e}">${e}</option>`).join("");let t=["major","minor_natural","minor_harmonic"];this.scaleSelect.innerHTML=t.map(e=>`<option value="${e}">${this.prettyScaleLabel(e)}</option>`).join("")}prettyScaleLabel(t){switch(t){case"major":return"Major";case"minor_natural":return"Natural Minor";case"minor_harmonic":return"Harmonic Minor";default:return String(t)}}setupEventHandlers(){this.rootSelect.addEventListener("change",()=>this.applyToModel()),this.scaleSelect.addEventListener("change",()=>this.applyToModel()),this.temperatureInput.addEventListener("change",()=>this.applyToModel())}syncFromParams(){let t=this.app.getDictationParams();this.rootSelect.value=t.rootNote.name,this.scaleSelect.value=t.type,this.temperatureInput.value=String(t.generationTemperature)}applyToModel(){let t=this.app.getDictationParams(),e=this.rootSelect.value,i=this.scaleSelect.value,r={...t,rootNote:N[e],type:i};this.app.setDictationParams(r);let a=parseFloat(this.temperatureInput.value);isNaN(a)||this.app.setGenerationTemperature?.(a)}};var B=class{constructor(){this.appViewModel=new P;let t=new V,e=new T,i=new I(this.appViewModel),r=new S(this.appViewModel),a=new C(this.appViewModel);this.appViewModel.initViewInteractions(t,e,i,r,a)}};document.addEventListener("DOMContentLoaded",()=>{new B});})();
