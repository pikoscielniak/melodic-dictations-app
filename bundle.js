"use strict";(()=>{var l=(s,t)=>()=>(t||s((t={exports:{}}).exports,t),t.exports);var h=l(d=>{"use strict";Object.defineProperty(d,"__esModule",{value:!0});d.AllNotes=d.NoteNamesFlats=d.NoteNames=d.RootMidiNotes=d.Scale=void 0;var Q;(function(s){s.MAJOR="major",s.MINOR_NATURAL="minor_natural",s.MINOR_HARMONIC="minor_harmonic"})(Q||(d.Scale=Q={}));d.RootMidiNotes={C:{name:"C",midiNumber:48},A:{name:"A",midiNumber:57},D:{name:"D",midiNumber:50},E:{name:"E",midiNumber:52},F:{name:"F",midiNumber:53},G:{name:"G",midiNumber:55},B:{name:"B",midiNumber:59},"C#":{name:"C#",midiNumber:49},"D#":{name:"D#",midiNumber:51},"F#":{name:"F#",midiNumber:54},"G#":{name:"G#",midiNumber:56},"A#":{name:"A#",midiNumber:58},Bb:{name:"Bb",midiNumber:58},Eb:{name:"Eb",midiNumber:51},Ab:{name:"Ab",midiNumber:56},Db:{name:"Db",midiNumber:49},Gb:{name:"Gb",midiNumber:54},Cb:{name:"Cb",midiNumber:59}};d.NoteNames=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];d.NoteNamesFlats=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"];d.AllNotes=["C","G","F","D","Bb","A","Eb","E","Ab","B","Db","F#","Gb","C#","Cb","G#"]});var O=l(N=>{"use strict";Object.defineProperty(N,"__esModule",{value:!0});N.areSameNotes=Nt;N.normalizePitch=R;N.getBaseOctave=vt;function Nt(s,t){return R(s)===R(t)}function R(s){return s%12}function vt(s){return Math.floor(s/12)*12}});var Z=l(y=>{"use strict";Object.defineProperty(y,"__esModule",{value:!0});y.ChordCadenceGenerator=void 0;var B=h(),X=O(),Y={[B.Scale.MAJOR]:[[0,4,7],[0,4,7],[0,4,7]],[B.Scale.MINOR_NATURAL]:[[0,3,7],[0,3,7],[0,3,7]],[B.Scale.MINOR_HARMONIC]:[[0,3,7],[0,3,7],[0,4,7]]},bt=[0,5,7,0],E=class{generateCadenceNotes(t,e,i){let n=(0,X.getBaseOctave)(i)-12,r=(a,o)=>{let c=Y[e].length,b=Y[e][o%c].map(pt=>a+pt);return[a-12,...b]};return bt.map((a,o)=>{let c=(0,X.normalizePitch)(t+a),u=n+c;return r(u,o)})}cadenceToNoteSequence(t,e=1){let i=[],n=0;for(let r of t){for(let a of r)i.push({pitch:a,startTime:n,endTime:n+e});n+=e}return{notes:i,totalTime:n}}generateCadence(t,e,i=1,n){let r=this.generateCadenceNotes(t.midiNumber,e,n);return this.cadenceToNoteSequence(r,i)}};y.ChordCadenceGenerator=E});var tt=l(g=>{"use strict";Object.defineProperty(g,"__esModule",{value:!0});g.ChordProgressionService=void 0;var v=h(),yt=[["I","IV","V","I"],["I","vi","IV","V"],["I","V","vi","IV"],["I","IV","vi","V"],["I","V","IV","I"],["I","IV","ii","V"],["I","ii","V","I"]],gt=[["i","iv","v","i"],["i","VI","iv","v"],["i","v","VI","iv"],["i","iv","VI","v"],["i","v","iv","i"],["i","iv","ii\xB07","v"],["i","ii\xB07","v","i"]],wt=[["i","iv","V","i"],["i","VI","iv","V"],["i","V","VI","iv"],["i","iv","VI","V"],["i","V","iv","i"],["i","iv","ii\xB07","V"],["i","ii\xB07","V","i"]],Pt=[0,2,4,5,7,9,11],_t=[0,2,3,5,7,8,10],T=class{formatChordName(t,e){if(e.includes("\xB07"))return t+"dim7";if(e.includes("\xB0"))return t+"dim";let i=e.charAt(0);return i===i.toLowerCase()&&i!==i.toUpperCase()?t+"m":t}getScaleDegree(t){switch(t.replace(/Â°(7)?/g,"").toLowerCase()){case"i":return 0;case"ii":return 1;case"iii":return 2;case"iv":return 3;case"v":return 4;case"vi":return 5;case"vii":return 6;default:return 0}}getProgressionForConcreteNote(t,e,i){let n=e===v.Scale.MAJOR?Pt:_t;return t.map(r=>{let a=this.getScaleDegree(r),o=(i+n[a])%12,c=v.NoteNames[o];return this.formatChordName(c,r)})}getRandomChordProgression(t){let e=this.getChordProgressions(t),i=Math.floor(Math.random()*e.length);return e[i]}getChordProgressions(t){if(t===v.Scale.MAJOR)return yt;if(t===v.Scale.MINOR_HARMONIC)return wt;if(t===v.Scale.MINOR_NATURAL)return gt;throw new Error(`Unsupported scale mode: ${t}`)}generateChordProgression(t,e){let i=this.getRandomChordProgression(t);return this.getProgressionForConcreteNote(i,t,e)}};g.ChordProgressionService=T});var et=l(w=>{"use strict";Object.defineProperty(w,"__esModule",{value:!0});w.DictationsGeneratorService=void 0;var k=class{constructor(){this.rnnImprov=new mm.MusicRNN("https://storage.googleapis.com/magentadata/js/checkpoints/music_rnn/chord_pitches_improv")}generateScaleData(t){let e=t.scale;return{notes:e,totalTime:e.length*.5}}init(){this.rnnImprov.initialize()}async generateDictation(t){let n=this.generateScaleData(t),r=mm.sequences.quantizeNoteSequence(n,4),a=t.chordProgression;return await this.rnnImprov.continueSequence(r,40,.6,a)}};w.DictationsGeneratorService=k});var it=l(P=>{"use strict";Object.defineProperty(P,"__esModule",{value:!0});P.DictationPlayer=void 0;var L=class{constructor(){this.player=new mm.SoundFontPlayer("https://storage.googleapis.com/magentadata/js/soundfonts/sgm_plus"),this.paused=!1}stop(){if(this.player.isPlaying()){this.player.stop();return}}async playCadence(t){this.stop(),await this.player.start(t)}async playDictation(t){this.pausedAtSec=null,this.currentDictation=t,this.stop(),await this.player.start(t),this.paused=!1}async playOneNote(t){this.stop();let e={notes:[{pitch:t.pitch+12,startTime:0,endTime:.6}],totalTime:.6};await this.player.start(e)}pause(){this.player.pause(),this.pausedAtSec=mm.Player.tone.Transport.seconds,this.paused=!0}async resume(){this.currentDictation&&(this.stop(),this.paused=!1,this.player.start(this.currentDictation,void 0,this.pausedAtSec??0))}isPlaying(){return this.player.isPlaying()}isPaused(){return this.paused}};P.DictationPlayer=L});var f=l(_=>{"use strict";Object.defineProperty(_,"__esModule",{value:!0});_.midiPitchToNoteName=Ct;_.getNoteName=nt;var p=h(),ft=new Set(["F","Bb","Eb","Ab","Db","Gb","Cb"]);function St(s){return s===p.Scale.MINOR_NATURAL||s===p.Scale.MINOR_HARMONIC}function st(s){switch(s){case"C#":return"Db";case"D#":return"Eb";case"F#":return"Gb";case"G#":return"Ab";case"A#":return"Bb";default:return s}}function Mt(s){let t=p.NoteNames.indexOf(s);if(t!==-1||(t=p.NoteNamesFlats.indexOf(s),t!==-1))return t;throw new Error(`Unknown note name: ${s}`)}function Dt(s,t){let e=s;if(St(t)){let r=(Mt(s)+3)%12,a=p.NoteNames[r];e=st(a)}let i=st(e);return ft.has(i)||/b/.test(i)}function Ct(s,t,e){let i=nt(s,t,e),n=Math.floor(s/12)-1;return`${i}${n}`}function nt(s,t,e){let i=(s%12+12)%12;return Dt(t,e)?p.NoteNamesFlats[i]:p.NoteNames[i]}});var rt=l(S=>{"use strict";Object.defineProperty(S,"__esModule",{value:!0});S.ScaleGeneratorService=void 0;var q=h(),It={[q.Scale.MAJOR]:[2,2,1,2,2,2,1],[q.Scale.MINOR_NATURAL]:[2,1,2,2,1,2,2],[q.Scale.MINOR_HARMONIC]:[2,1,2,2,1,3,1]},j=class{generateScale(t){let e=It[t.type],i=[],n=t.rootNote.midiNumber,r=n,a=0,o=.5;for(let c=0;c<t.octaves;c++){i.push({pitch:r,startTime:a,endTime:a+o}),a+=o;for(let u=0;u<e.length;u++)r+=e[u],i.push({pitch:r,startTime:a,endTime:a+o}),a+=o;r=n+12*(c+1)}return i}};S.ScaleGeneratorService=j});var ot=l(M=>{"use strict";Object.defineProperty(M,"__esModule",{value:!0});M.AppViewModel=void 0;var At=Z(),Vt=tt(),G=h(),x=O(),Rt=et(),Ot=it(),at=f(),Bt=rt(),F=class{constructor(){this.chordCadenceGenerator=new At.ChordCadenceGenerator,this.currentCadence={notes:[],totalTime:0},this.currentRevealIndex=0,this.currentNotes=[],this.isPaused=!1,this.dictationPlayer=new Ot.DictationPlayer,this.currentDictationParams={rootNote:G.RootMidiNotes.A,octaves:2,type:G.Scale.MINOR_HARMONIC},this.dictationsService=new Rt.DictationsGeneratorService,this.scaleGenerator=new Bt.ScaleGeneratorService,this.chordProgressionService=new Vt.ChordProgressionService,this.dictationsService.init()}getDictationParams(){return this.currentDictationParams}setDictationParams(t){this.currentDictationParams=t}getTargetNoteOrLast(){let t=this.currentNotes;return this.currentSample&&t&&this.currentRevealIndex<t.length?t[this.currentRevealIndex]:t[t.length-1]}hasNoteToDiscover(){return this.currentRevealIndex<this.currentNotes.length}onKeyboardNoteClick(t){let e=this.currentDictationParams,i=this.getTargetNoteOrLast(),n=(0,x.getBaseOctave)(i.pitch),r=(0,x.normalizePitch)(t.pitch),a=n-12+r,o={pitch:a,name:(0,at.getNoteName)(a,e.rootNote.name,e.type)};this.dictationPlayer.playOneNote(o),this.hasNoteToDiscover()&&((0,x.areSameNotes)(t.pitch,i.pitch)?(this.notesDisplay.revealNoteAt(this.currentRevealIndex,i,e.rootNote,e.type),this.notesDisplay.markCorrectAt(this.currentRevealIndex),this.currentRevealIndex++,this.currentRevealIndex>=this.currentNotes.length&&this.buttonsView.setShowNoteEnabled(!1)):this.notesDisplay.markWrongAt(this.currentRevealIndex))}async startDictation(){let t=this.generateDictationData(this.currentDictationParams);this.currentSample=await this.dictationsService.generateDictation(t),this.currentNotes=this.currentSample.notes||[];let e=this.currentNotes?.[0]?.pitch;this.currentCadence=this.chordCadenceGenerator.generateCadence(this.currentDictationParams.rootNote,this.currentDictationParams.type,1,e),this.currentRevealIndex=0,this.dictationParamsView.updateView(this.currentDictationParams),this.notesDisplay.renderPlaceholders(this.currentSample?.notes);let i=this.currentDictationParams.rootNote.midiNumber;this.keyboardView.renderPianoOctave(i),this.buttonsView.setActionsEnabled(!0),this.buttonsView.setShowNoteEnabled(!0),this.buttonsView.setPauseState(!1),await this.playCadence(),await this.sleep(1e3),await this.playDictation()}generateDictationData(t){let e=this.scaleGenerator.generateScale(t);return{chordProgression:this.chordProgressionService.generateChordProgression(G.Scale.MAJOR,t.rootNote.midiNumber),scale:e}}sleep(t){return new Promise(e=>setTimeout(e,t))}async playDictation(){this.currentSample&&(await this.dictationPlayer.playDictation(this.currentSample),this.isPaused=!1,this.buttonsView.setPauseState(!1))}async playCadence(){this.currentCadence&&await this.dictationPlayer.playCadence(this.currentCadence)}getOneOctaveScale(t){return this.scaleGenerator.generateScale({...t,octaves:1}).map(i=>({pitch:i.pitch,name:(0,at.getNoteName)(i.pitch,this.currentDictationParams.rootNote.name,this.currentDictationParams.type)}))}initViewInteractions(t,e,i,n){this.notesDisplay=t,this.dictationParamsView=e,this.keyboardView=i,this.buttonsView=n}async togglePause(){this.isPaused=!this.isPaused,this.buttonsView.setPauseState(this.isPaused),this.isPaused?this.dictationPlayer.pause():await this.dictationPlayer.resume()}revealNextNote(){if(!this.currentSample||!this.currentSample.notes)return;let t=this.currentSample.notes;if(this.currentRevealIndex>=t.length){this.buttonsView.setShowNoteEnabled(!1);return}let e=this.currentRevealIndex,i=t[e];this.notesDisplay.revealNoteAt(e,i,this.currentDictationParams.rootNote,this.currentDictationParams.type),this.currentRevealIndex++,this.currentRevealIndex>=t.length&&this.buttonsView.setShowNoteEnabled(!1)}};M.AppViewModel=F});var ct=l(D=>{"use strict";Object.defineProperty(D,"__esModule",{value:!0});D.ButtonsView=void 0;var H=class{constructor(t){this.startBtn=document.getElementById("start"),this.playDictationBtn=document.getElementById("play-dictation"),this.playCadenceBtn=document.getElementById("play-cadence"),this.pauseDictationBtn=document.getElementById("pause-dictation"),this.appViewModel=t,this.showNoteBtn=document.getElementById("show-note"),this.setupEventListeners()}setupEventListeners(){this.startBtn?.addEventListener("click",async()=>await this.appViewModel.startDictation()),this.playDictationBtn?.addEventListener("click",async()=>await this.appViewModel.playDictation()),this.playCadenceBtn?.addEventListener("click",async()=>await this.appViewModel.playCadence()),this.showNoteBtn?.addEventListener("click",()=>this.appViewModel.revealNextNote()),this.pauseDictationBtn?.addEventListener("click",()=>this.appViewModel.togglePause())}setActionsEnabled(t){this.playDictationBtn&&(this.playDictationBtn.disabled=!t,this.playDictationBtn.setAttribute("aria-disabled",String(!t))),this.playCadenceBtn&&(this.playCadenceBtn.disabled=!t,this.playCadenceBtn.setAttribute("aria-disabled",String(!t))),this.pauseDictationBtn&&(this.pauseDictationBtn.disabled=!t,this.pauseDictationBtn.setAttribute("aria-disabled",String(!t))),this.showNoteBtn&&(this.showNoteBtn.disabled=!t,this.showNoteBtn.setAttribute("aria-disabled",String(!t)))}setShowNoteEnabled(t){this.showNoteBtn&&(this.showNoteBtn.disabled=!t,this.showNoteBtn.setAttribute("aria-disabled",String(!t)))}setPauseState(t){this.pauseDictationBtn&&(this.pauseDictationBtn.textContent=t?"Resume":"Pause",this.pauseDictationBtn.setAttribute("aria-pressed",String(t)))}};D.ButtonsView=H});var lt=l(C=>{"use strict";Object.defineProperty(C,"__esModule",{value:!0});C.DictationParamsView=void 0;var $=h(),U=class{constructor(){this.dictationParamsSection=document.getElementById("dictation-params-section"),this.dictationParamsDiv=document.getElementById("dictation-params")}convertType(t){switch(t){case $.Scale.MAJOR:return"Major";case $.Scale.MINOR_NATURAL:return"Natural Minor";case $.Scale.MINOR_HARMONIC:return"Harmonic Minor";default:return"Unknown"}}updateView(t){this.dictationParamsDiv&&(this.dictationParamsDiv.innerHTML=`
            <p><strong>Scale:</strong> <span>${t.rootNote.name} ${this.convertType(t.type)}</span></p>
        `,this.dictationParamsSection.style.display="block")}};C.DictationParamsView=U});var ut=l(I=>{"use strict";Object.defineProperty(I,"__esModule",{value:!0});I.KeyboardView=void 0;var Et=f(),Tt="keyboard",J=class{constructor(t){this.container=document.getElementById(Tt),this.appViewModel=t}renderScale(t){if(this.container){this.container.innerHTML="";for(let e of t){let i=e.pitch,n=e.name,r=document.createElement("button");r.className="key-btn btn",r.type="button",r.setAttribute("data-pitch",String(i)),r.setAttribute("aria-label",`${n} (${i})`),r.textContent=n,r.addEventListener("click",()=>this.onClick({pitch:i,name:n})),this.container.appendChild(r)}}}renderPianoOctave(t){if(!this.container)return;this.container.innerHTML="";let e=this.appViewModel.getDictationParams(),i=document.createElement("div");i.className="kb-row kb-row--black";let n=document.createElement("div");n.className="kb-row kb-row--white";let r=o=>[0,2,4,5,7,9,11].includes(o),a=[];for(let o=t;o<=t+12;o++){let c=(o%12+12)%12;if(r(c)&&a.push({pitch:o,pc:c}),a.length===8)break}a.forEach((o,c)=>{let u=this.makeKeyButton(o.pitch,e.rootNote.name,e.type,!1);u.style.gridColumn=`${c*2+1} / span 2`,n.appendChild(u)});for(let o=0;o<a.length-1;o++){let c=a[o];if(c.pc===4||c.pc===11)continue;let u=c.pitch+1;if(u>=t+12)continue;let b=this.makeKeyButton(u,e.rootNote.name,e.type,!0);b.style.gridColumn=`${o*2+2} / span 2`,i.appendChild(b)}this.container.appendChild(i),this.container.appendChild(n)}makeKeyButton(t,e,i,n){let r=(0,Et.getNoteName)(t,e,i),a=document.createElement("button");return a.className=`key-btn btn ${n?"key--black":"key--white"}`,a.type="button",a.setAttribute("data-pitch",String(t)),a.setAttribute("aria-label",`${r} (${t})`),a.textContent=r,a.addEventListener("click",()=>this.onClick({pitch:t,name:r})),a}onClick(t){this.appViewModel.onKeyboardNoteClick(t)}};I.KeyboardView=J});var dt=l(A=>{"use strict";Object.defineProperty(A,"__esModule",{value:!0});A.NotesView=void 0;var kt=f(),K=class{constructor(){this.placeholdersEl=document.getElementById("placeholders")}renderPlaceholders(t){let e=Array.from({length:t.length},()=>"<li>?</li>").join("");this.placeholdersEl.innerHTML=e}revealNoteAt(t,e,i,n){let r=this.placeholdersEl.children.item(t);r.textContent=(0,kt.midiPitchToNoteName)(e.pitch,i.name,n),r.classList.remove("note--wrong"),r.classList.add("note--correct")}markCorrectAt(t){let e=this.placeholdersEl.children.item(t);e.classList.remove("note--wrong"),e.classList.add("note--correct")}markWrongAt(t){let e=this.placeholdersEl.children.item(t);e.classList.remove("note--correct"),e.classList.add("note--wrong")}};A.NotesView=K});var ht=l(V=>{"use strict";Object.defineProperty(V,"__esModule",{value:!0});V.SelectorsView=void 0;var m=h(),z=class{constructor(t){this.app=t,this.rootSelect=document.getElementById("root-select"),this.scaleSelect=document.getElementById("scale-select"),this.renderOptions(),this.setupEventHandlers(),this.syncFromParams()}renderOptions(){this.rootSelect.innerHTML=m.AllNotes.map(e=>`<option value="${e}">${e}</option>`).join("");let t=[m.Scale.MAJOR,m.Scale.MINOR_NATURAL,m.Scale.MINOR_HARMONIC];this.scaleSelect.innerHTML=t.map(e=>`<option value="${e}">${this.prettyScaleLabel(e)}</option>`).join("")}prettyScaleLabel(t){switch(t){case m.Scale.MAJOR:return"Major";case m.Scale.MINOR_NATURAL:return"Natural Minor";case m.Scale.MINOR_HARMONIC:return"Harmonic Minor";default:return String(t)}}setupEventHandlers(){this.rootSelect.addEventListener("change",()=>this.applyToModel()),this.scaleSelect.addEventListener("change",()=>this.applyToModel())}syncFromParams(){let t=this.app.getDictationParams();this.rootSelect.value=t.rootNote.name,this.scaleSelect.value=t.type}applyToModel(){let t=this.app.getDictationParams(),e=this.rootSelect.value,i=this.scaleSelect.value,n={...t,rootNote:m.RootMidiNotes[e],type:i};this.app.setDictationParams(n)}};V.SelectorsView=z});var Ht=l(mt=>{Object.defineProperty(mt,"__esModule",{value:!0});var Lt=ot(),qt=ct(),jt=lt(),Gt=ut(),xt=dt(),Ft=ht(),W=class{constructor(){this.appViewModel=new Lt.AppViewModel;let t=new xt.NotesView,e=new jt.DictationParamsView,i=new Gt.KeyboardView(this.appViewModel),n=new qt.ButtonsView(this.appViewModel);new Ft.SelectorsView(this.appViewModel),this.appViewModel.initViewInteractions(t,e,i,n)}};document.addEventListener("DOMContentLoaded",()=>{new W})});Ht();})();
