"use strict";(()=>{var l=(n,e)=>()=>(e||n((e={exports:{}}).exports,e),e.exports);var h=l(d=>{"use strict";Object.defineProperty(d,"__esModule",{value:!0});d.AllNotes=d.NoteNamesFlats=d.NoteNames=d.RootMidiNotes=d.Scale=void 0;var Q;(function(n){n.MAJOR="major",n.MINOR_NATURAL="minor_natural",n.MINOR_HARMONIC="minor_harmonic"})(Q||(d.Scale=Q={}));d.RootMidiNotes={C:{name:"C",midiNumber:48},A:{name:"A",midiNumber:57},D:{name:"D",midiNumber:50},E:{name:"E",midiNumber:52},F:{name:"F",midiNumber:53},G:{name:"G",midiNumber:55},B:{name:"B",midiNumber:59},"C#":{name:"C#",midiNumber:49},"D#":{name:"D#",midiNumber:51},"F#":{name:"F#",midiNumber:54},"G#":{name:"G#",midiNumber:56},"A#":{name:"A#",midiNumber:58},Bb:{name:"Bb",midiNumber:58},Eb:{name:"Eb",midiNumber:51},Ab:{name:"Ab",midiNumber:56},Db:{name:"Db",midiNumber:49},Gb:{name:"Gb",midiNumber:54},Cb:{name:"Cb",midiNumber:59}};d.NoteNames=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];d.NoteNamesFlats=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"];d.AllNotes=["C","G","F","D","Bb","A","Eb","E","Ab","B","Db","F#","Gb","C#","Cb","G#"]});var O=l(N=>{"use strict";Object.defineProperty(N,"__esModule",{value:!0});N.areSameNotes=Ne;N.normalizePitch=R;N.getBaseOctave=ve;function Ne(n,e){return R(n)===R(e)}function R(n){return n%12}function ve(n){return Math.floor(n/12)*12}});var Z=l(y=>{"use strict";Object.defineProperty(y,"__esModule",{value:!0});y.ChordCadenceGenerator=void 0;var B=h(),X=O(),Y={[B.Scale.MAJOR]:[[0,4,7],[0,4,7],[0,4,7]],[B.Scale.MINOR_NATURAL]:[[0,3,7],[0,3,7],[0,3,7]],[B.Scale.MINOR_HARMONIC]:[[0,3,7],[0,3,7],[0,4,7]]},ge=[0,5,7,0],E=class{generateCadenceNotes(e,t,i){let r=(0,X.getBaseOctave)(i)-12,s=(a,o)=>{let c=Y[t].length,g=Y[t][o%c].map(me=>a+me);return[a-12,...g]};return ge.map((a,o)=>{let c=(0,X.normalizePitch)(e+a),u=r+c;return s(u,o)})}cadenceToNoteSequence(e,t){let i=[],r=0;for(let s of e){for(let a of s)i.push({pitch:a,startTime:r,endTime:r+t});r+=t}return{notes:i,totalTime:r}}generateCadence(e,t,i,r){let s=this.generateCadenceNotes(e.midiNumber,t,r);return this.cadenceToNoteSequence(s,i)}};y.ChordCadenceGenerator=E});var ee=l(b=>{"use strict";Object.defineProperty(b,"__esModule",{value:!0});b.ChordProgressionService=void 0;var v=h(),ye=[["I","IV","V","I"],["I","vi","IV","V"],["I","V","vi","IV"],["I","IV","vi","V"],["I","V","IV","I"],["I","IV","ii","V"],["I","ii","V","I"]],be=[["i","iv","v","i"],["i","VI","iv","v"],["i","v","VI","iv"],["i","iv","VI","v"],["i","v","iv","i"],["i","iv","ii\xB07","v"],["i","ii\xB07","v","i"]],we=[["i","iv","V","i"],["i","VI","iv","V"],["i","V","VI","iv"],["i","iv","VI","V"],["i","V","iv","i"],["i","iv","ii\xB07","V"],["i","ii\xB07","V","i"]],Pe=[0,2,4,5,7,9,11],fe=[0,2,3,5,7,8,10],T=class{formatChordName(e,t){if(t.includes("\xB07"))return e+"dim7";if(t.includes("\xB0"))return e+"dim";let i=t.charAt(0);return i===i.toLowerCase()&&i!==i.toUpperCase()?e+"m":e}getScaleDegree(e){switch(e.replace(/Â°(7)?/g,"").toLowerCase()){case"i":return 0;case"ii":return 1;case"iii":return 2;case"iv":return 3;case"v":return 4;case"vi":return 5;case"vii":return 6;default:return 0}}getProgressionForConcreteNote(e,t,i){let r=t===v.Scale.MAJOR?Pe:fe;return e.map(s=>{let a=this.getScaleDegree(s),o=(i+r[a])%12,c=v.NoteNames[o];return this.formatChordName(c,s)})}getRandomChordProgression(e){let t=this.getChordProgressions(e),i=Math.floor(Math.random()*t.length);return t[i]}getChordProgressions(e){if(e===v.Scale.MAJOR)return ye;if(e===v.Scale.MINOR_HARMONIC)return we;if(e===v.Scale.MINOR_NATURAL)return be;throw new Error(`Unsupported scale mode: ${e}`)}generateChordProgression(e,t){let i=this.getRandomChordProgression(e);return this.getProgressionForConcreteNote(i,e,t)}};b.ChordProgressionService=T});var te=l(w=>{"use strict";Object.defineProperty(w,"__esModule",{value:!0});w.DictationsGeneratorService=void 0;var k=class{constructor(){this.rnnImprov=new mm.MusicRNN("https://storage.googleapis.com/magentadata/js/checkpoints/music_rnn/chord_pitches_improv")}generateScaleData(e){let t=e.scale;return{notes:t,totalTime:t.length*.5}}init(){this.rnnImprov.initialize()}async generateDictation(e,t){let r=t,s=this.generateScaleData(e),a=mm.sequences.quantizeNoteSequence(s,4),o=e.chordProgression;return await this.rnnImprov.continueSequence(a,40,r,o)}};w.DictationsGeneratorService=k});var ie=l(P=>{"use strict";Object.defineProperty(P,"__esModule",{value:!0});P.DictationPlayer=void 0;var L=class{constructor(){this.player=new mm.SoundFontPlayer("https://storage.googleapis.com/magentadata/js/soundfonts/sgm_plus"),this.paused=!1}stop(){if(this.player.isPlaying()){this.player.stop();return}}async playCadence(e){this.stop(),await this.player.start(e)}async playDictation(e){this.pausedAtSec=null,this.currentDictation=e,this.stop(),await this.player.start(e),this.paused=!1}async playOneNote(e){this.stop();let t={notes:[{pitch:e.pitch+12,startTime:0,endTime:.6}],totalTime:.6};await this.player.start(t)}pause(){this.player.pause(),this.pausedAtSec=mm.Player.tone.Transport.seconds,this.paused=!0}async resume(){this.currentDictation&&(this.stop(),this.paused=!1,this.player.start(this.currentDictation,void 0,this.pausedAtSec??0))}isPlaying(){return this.player.isPlaying()}isPaused(){return this.paused}};P.DictationPlayer=L});var S=l(f=>{"use strict";Object.defineProperty(f,"__esModule",{value:!0});f.midiPitchToNoteName=Ie;f.getNoteName=ne;var m=h(),Se=new Set(["F","Bb","Eb","Ab","Db","Gb","Cb"]);function _e(n){return n===m.Scale.MINOR_NATURAL||n===m.Scale.MINOR_HARMONIC}function se(n){switch(n){case"C#":return"Db";case"D#":return"Eb";case"F#":return"Gb";case"G#":return"Ab";case"A#":return"Bb";default:return n}}function Me(n){let e=m.NoteNames.indexOf(n);if(e!==-1||(e=m.NoteNamesFlats.indexOf(n),e!==-1))return e;throw new Error(`Unknown note name: ${n}`)}function De(n,e){let t=n;if(_e(e)){let s=(Me(n)+3)%12,a=m.NoteNames[s];t=se(a)}let i=se(t);return Se.has(i)||/b/.test(i)}function Ie(n,e,t){let i=ne(n,e,t),r=Math.floor(n/12)-1;return`${i}${r}`}function ne(n,e,t){let i=(n%12+12)%12;return De(e,t)?m.NoteNamesFlats[i]:m.NoteNames[i]}});var re=l(_=>{"use strict";Object.defineProperty(_,"__esModule",{value:!0});_.ScaleGeneratorService=void 0;var G=h(),Ce={[G.Scale.MAJOR]:[2,2,1,2,2,2,1],[G.Scale.MINOR_NATURAL]:[2,1,2,2,1,2,2],[G.Scale.MINOR_HARMONIC]:[2,1,2,2,1,3,1]},q=class{generateScale(e){let t=Ce[e.type],i=[],r=e.rootNote.midiNumber,s=r,a=0,o=.5;for(let c=0;c<e.octaves;c++){i.push({pitch:s,startTime:a,endTime:a+o}),a+=o;for(let u=0;u<t.length;u++)s+=t[u],i.push({pitch:s,startTime:a,endTime:a+o}),a+=o;s=r+12*(c+1)}return i}};_.ScaleGeneratorService=q});var oe=l(M=>{"use strict";Object.defineProperty(M,"__esModule",{value:!0});M.AppViewModel=void 0;var Ae=Z(),Ve=ee(),j=h(),F=O(),Re=te(),Oe=ie(),ae=S(),Be=re(),x=class{getGenerationTemperature(){return this.generationTemperature}setGenerationTemperature(e){e=Math.max(.1,Math.min(1.5,e)),this.generationTemperature=e,this.selectorsView.syncFromParams()}constructor(){this.chordCadenceGenerator=new Ae.ChordCadenceGenerator,this.currentCadence={notes:[],totalTime:0},this.currentRevealIndex=0,this.currentNotes=[],this.isPaused=!1,this.cadenceSpeed=.5,this.generationTemperature=.6,this.dictationPlayer=new Oe.DictationPlayer,this.currentDictationParams={rootNote:j.RootMidiNotes.C,octaves:2,type:j.Scale.MAJOR},this.dictationsService=new Re.DictationsGeneratorService,this.scaleGenerator=new Be.ScaleGeneratorService,this.chordProgressionService=new Ve.ChordProgressionService,this.dictationsService.init()}getDictationParams(){return this.currentDictationParams}setDictationParams(e){this.currentDictationParams=e}getTargetNoteOrLast(){let e=this.currentNotes;return this.currentSample&&e&&this.currentRevealIndex<e.length?e[this.currentRevealIndex]:e[e.length-1]}hasNoteToDiscover(){return this.currentRevealIndex<this.currentNotes.length}onKeyboardNoteClick(e){let t=this.currentDictationParams,i=this.getTargetNoteOrLast(),r=(0,F.getBaseOctave)(i.pitch),s=(0,F.normalizePitch)(e.pitch),a=r-12+s,o={pitch:a,name:(0,ae.getNoteName)(a,t.rootNote.name,t.type)};this.dictationPlayer.playOneNote(o),this.hasNoteToDiscover()&&((0,F.areSameNotes)(e.pitch,i.pitch)?(this.notesDisplay.revealNoteAt(this.currentRevealIndex,i,t.rootNote,t.type),this.notesDisplay.markCorrectAt(this.currentRevealIndex),this.currentRevealIndex++,this.currentRevealIndex>=this.currentNotes.length&&this.buttonsView.setShowNoteEnabled(!1)):this.notesDisplay.markWrongAt(this.currentRevealIndex))}async startDictation(){let e=this.generateDictationData(this.currentDictationParams);this.currentSample=await this.dictationsService.generateDictation(e,this.generationTemperature),this.currentNotes=this.currentSample.notes||[];let t=this.currentNotes?.[0]?.pitch;this.currentCadence=this.chordCadenceGenerator.generateCadence(this.currentDictationParams.rootNote,this.currentDictationParams.type,this.cadenceSpeed,t),this.currentRevealIndex=0,this.dictationParamsView.updateView(this.currentDictationParams),this.notesDisplay.renderPlaceholders(this.currentSample?.notes);let i=this.currentDictationParams.rootNote.midiNumber;this.keyboardView.renderPianoOctave(i),this.buttonsView.setActionsEnabled(!0),this.buttonsView.setShowNoteEnabled(!0),this.buttonsView.setPauseState(!1),await this.playCadence(),await this.sleep(1e3),await this.playDictation()}generateDictationData(e){let t=this.scaleGenerator.generateScale(e);return{chordProgression:this.chordProgressionService.generateChordProgression(j.Scale.MAJOR,e.rootNote.midiNumber),scale:t}}sleep(e){return new Promise(t=>setTimeout(t,e))}async playDictation(){this.currentSample&&(this.isPaused=!1,this.buttonsView.setPauseState(!1),await this.dictationPlayer.playDictation(this.currentSample))}async playCadence(){this.currentCadence&&await this.dictationPlayer.playCadence(this.currentCadence)}getOneOctaveScale(e){return this.scaleGenerator.generateScale({...e,octaves:1}).map(i=>({pitch:i.pitch,name:(0,ae.getNoteName)(i.pitch,this.currentDictationParams.rootNote.name,this.currentDictationParams.type)}))}initViewInteractions(e,t,i,r,s){this.notesDisplay=e,this.dictationParamsView=t,this.keyboardView=i,this.buttonsView=r,this.selectorsView=s}async togglePause(){this.isPaused=!this.isPaused,this.buttonsView.setPauseState(this.isPaused),this.isPaused?this.dictationPlayer.pause():await this.dictationPlayer.resume()}revealNextNote(){if(!this.currentSample||!this.currentSample.notes)return;let e=this.currentSample.notes;if(this.currentRevealIndex>=e.length){this.buttonsView.setShowNoteEnabled(!1);return}let t=this.currentRevealIndex,i=e[t];this.notesDisplay.revealNoteAt(t,i,this.currentDictationParams.rootNote,this.currentDictationParams.type),this.currentRevealIndex++,this.currentRevealIndex>=e.length&&this.buttonsView.setShowNoteEnabled(!1)}};M.AppViewModel=x});var ce=l(D=>{"use strict";Object.defineProperty(D,"__esModule",{value:!0});D.ButtonsView=void 0;var H=class{constructor(e){this.startBtn=document.getElementById("start"),this.playDictationBtn=document.getElementById("play-dictation"),this.playCadenceBtn=document.getElementById("play-cadence"),this.pauseDictationBtn=document.getElementById("pause-dictation"),this.appViewModel=e,this.showNoteBtn=document.getElementById("show-note"),this.setupEventListeners()}setupEventListeners(){this.startBtn?.addEventListener("click",async()=>await this.appViewModel.startDictation()),this.playDictationBtn?.addEventListener("click",async()=>await this.appViewModel.playDictation()),this.playCadenceBtn?.addEventListener("click",async()=>await this.appViewModel.playCadence()),this.showNoteBtn?.addEventListener("click",()=>this.appViewModel.revealNextNote()),this.pauseDictationBtn?.addEventListener("click",()=>this.appViewModel.togglePause())}setActionsEnabled(e){this.playDictationBtn&&(this.playDictationBtn.disabled=!e,this.playDictationBtn.setAttribute("aria-disabled",String(!e))),this.playCadenceBtn&&(this.playCadenceBtn.disabled=!e,this.playCadenceBtn.setAttribute("aria-disabled",String(!e))),this.pauseDictationBtn&&(this.pauseDictationBtn.disabled=!e,this.pauseDictationBtn.setAttribute("aria-disabled",String(!e))),this.showNoteBtn&&(this.showNoteBtn.disabled=!e,this.showNoteBtn.setAttribute("aria-disabled",String(!e)))}setShowNoteEnabled(e){this.showNoteBtn&&(this.showNoteBtn.disabled=!e,this.showNoteBtn.setAttribute("aria-disabled",String(!e)))}setPauseState(e){this.pauseDictationBtn&&(this.pauseDictationBtn.textContent=e?"Resume":"Pause",this.pauseDictationBtn.setAttribute("aria-pressed",String(e)))}};D.ButtonsView=H});var le=l(I=>{"use strict";Object.defineProperty(I,"__esModule",{value:!0});I.DictationParamsView=void 0;var $=h(),U=class{constructor(){this.dictationParamsSection=document.getElementById("dictation-params-section"),this.dictationParamsDiv=document.getElementById("dictation-params")}convertType(e){switch(e){case $.Scale.MAJOR:return"Major";case $.Scale.MINOR_NATURAL:return"Natural Minor";case $.Scale.MINOR_HARMONIC:return"Harmonic Minor";default:return"Unknown"}}updateView(e){this.dictationParamsDiv&&(this.dictationParamsDiv.innerHTML=`
            <p><strong>Scale:</strong> <span>${e.rootNote.name} ${this.convertType(e.type)}</span></p>
        `,this.dictationParamsSection.style.display="block")}};I.DictationParamsView=U});var ue=l(C=>{"use strict";Object.defineProperty(C,"__esModule",{value:!0});C.KeyboardView=void 0;var Ee=S(),Te="keyboard",J=class{constructor(e){this.container=document.getElementById(Te),this.appViewModel=e}renderScale(e){if(this.container){this.container.innerHTML="";for(let t of e){let i=t.pitch,r=t.name,s=document.createElement("button");s.className="key-btn btn",s.type="button",s.setAttribute("data-pitch",String(i)),s.setAttribute("aria-label",`${r} (${i})`),s.textContent=r,s.addEventListener("click",()=>this.onClick({pitch:i,name:r})),this.container.appendChild(s)}}}renderPianoOctave(e){if(!this.container)return;this.container.innerHTML="";let t=this.appViewModel.getDictationParams(),i=document.createElement("div");i.className="kb-row kb-row--black";let r=document.createElement("div");r.className="kb-row kb-row--white";let s=o=>[0,2,4,5,7,9,11].includes(o),a=[];for(let o=e;o<=e+12;o++){let c=(o%12+12)%12;if(s(c)&&a.push({pitch:o,pc:c}),a.length===8)break}a.forEach((o,c)=>{let u=this.makeKeyButton(o.pitch,t.rootNote.name,t.type,!1);u.style.gridColumn=`${c*2+1} / span 2`,r.appendChild(u)});for(let o=0;o<a.length-1;o++){let c=a[o];if(c.pc===4||c.pc===11)continue;let u=c.pitch+1;if(u>=e+12)continue;let g=this.makeKeyButton(u,t.rootNote.name,t.type,!0);g.style.gridColumn=`${o*2+2} / span 2`,i.appendChild(g)}this.container.appendChild(i),this.container.appendChild(r)}makeKeyButton(e,t,i,r){let s=(0,Ee.getNoteName)(e,t,i),a=document.createElement("button");return a.className=`key-btn btn ${r?"key--black":"key--white"}`,a.type="button",a.setAttribute("data-pitch",String(e)),a.setAttribute("aria-label",`${s} (${e})`),a.textContent=s,a.addEventListener("click",()=>this.onClick({pitch:e,name:s})),a}onClick(e){this.appViewModel.onKeyboardNoteClick(e)}};C.KeyboardView=J});var de=l(A=>{"use strict";Object.defineProperty(A,"__esModule",{value:!0});A.NotesView=void 0;var ke=S(),K=class{constructor(){this.placeholdersEl=document.getElementById("placeholders")}renderPlaceholders(e){let t=Array.from({length:e.length},()=>"<li>?</li>").join("");this.placeholdersEl.innerHTML=t}revealNoteAt(e,t,i,r){let s=this.placeholdersEl.children.item(e);s.textContent=(0,ke.midiPitchToNoteName)(t.pitch,i.name,r),s.classList.remove("note--wrong"),s.classList.add("note--correct")}markCorrectAt(e){let t=this.placeholdersEl.children.item(e);t.classList.remove("note--wrong"),t.classList.add("note--correct")}markWrongAt(e){let t=this.placeholdersEl.children.item(e);t.classList.remove("note--correct"),t.classList.add("note--wrong")}};A.NotesView=K});var he=l(V=>{"use strict";Object.defineProperty(V,"__esModule",{value:!0});V.SelectorsView=void 0;var p=h(),z=class{constructor(e){this.app=e,this.rootSelect=document.getElementById("root-select"),this.scaleSelect=document.getElementById("scale-select"),this.temperatureInput=document.getElementById("generation-temperature"),this.renderOptions(),this.setupEventHandlers(),this.syncFromParams()}renderOptions(){this.rootSelect.innerHTML=p.AllNotes.map(t=>`<option value="${t}">${t}</option>`).join("");let e=[p.Scale.MAJOR,p.Scale.MINOR_NATURAL,p.Scale.MINOR_HARMONIC];this.scaleSelect.innerHTML=e.map(t=>`<option value="${t}">${this.prettyScaleLabel(t)}</option>`).join("")}prettyScaleLabel(e){switch(e){case p.Scale.MAJOR:return"Major";case p.Scale.MINOR_NATURAL:return"Natural Minor";case p.Scale.MINOR_HARMONIC:return"Harmonic Minor";default:return String(e)}}setupEventHandlers(){this.rootSelect.addEventListener("change",()=>this.applyToModel()),this.scaleSelect.addEventListener("change",()=>this.applyToModel()),this.temperatureInput.addEventListener("input",()=>this.applyToModel())}syncFromParams(){let e=this.app.getDictationParams();this.rootSelect.value=e.rootNote.name,this.scaleSelect.value=e.type,this.temperatureInput.value=String(this.app.getGenerationTemperature?.()??.6)}applyToModel(){let e=this.app.getDictationParams(),t=this.rootSelect.value,i=this.scaleSelect.value,r={...e,rootNote:p.RootMidiNotes[t],type:i};this.app.setDictationParams(r);let s=parseFloat(this.temperatureInput.value);isNaN(s)||this.app.setGenerationTemperature?.(s)}};V.SelectorsView=z});var He=l(pe=>{Object.defineProperty(pe,"__esModule",{value:!0});var Le=oe(),Ge=ce(),qe=le(),je=ue(),Fe=de(),xe=he(),W=class{constructor(){this.appViewModel=new Le.AppViewModel;let e=new Fe.NotesView,t=new qe.DictationParamsView,i=new je.KeyboardView(this.appViewModel),r=new Ge.ButtonsView(this.appViewModel),s=new xe.SelectorsView(this.appViewModel);this.appViewModel.initViewInteractions(e,t,i,r,s)}};document.addEventListener("DOMContentLoaded",()=>{new W})});He();})();
