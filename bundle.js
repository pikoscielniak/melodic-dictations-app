"use strict";(()=>{var N={C:{name:"C",midiNumber:48},A:{name:"A",midiNumber:57},D:{name:"D",midiNumber:50},E:{name:"E",midiNumber:52},F:{name:"F",midiNumber:53},G:{name:"G",midiNumber:55},B:{name:"B",midiNumber:59},"C#":{name:"C#",midiNumber:49},"D#":{name:"D#",midiNumber:51},"F#":{name:"F#",midiNumber:54},"G#":{name:"G#",midiNumber:56},"A#":{name:"A#",midiNumber:58},Bb:{name:"Bb",midiNumber:58},Eb:{name:"Eb",midiNumber:51},Ab:{name:"Ab",midiNumber:56},Db:{name:"Db",midiNumber:49},Gb:{name:"Gb",midiNumber:54},Cb:{name:"Cb",midiNumber:59}},p=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],A=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"],R=["C","G","F","D","Bb","A","Eb","E","Ab","B","Db","F#","Gb","C#","Cb","G#"],b=.5;function L(o,t){return u(o)===u(t)}function u(o){return o%12}var x={major:[[0,4,7],[0,4,7],[0,4,7]],minor_natural:[[0,3,7],[0,3,7],[0,3,7]],minor_harmonic:[[0,3,7],[0,3,7],[0,4,7]]},H=[0,5,7,0],y=class{generateCadenceNotes(t,e,i){let a=(n,c)=>{let s=x[e].length,l=x[e][c%s].map(k=>n+k);return[n-12,...l]};return H.map((n,c)=>{let m=48+u(t+n);return a(m,c)})}cadenceToNoteSequence(t,e){let i=[],r=0;for(let a of t){for(let n of a)i.push({pitch:n,startTime:r,endTime:r+e});r+=e}return{notes:i,totalTime:r}}generateCadence(t,e,i,r){let a=this.generateCadenceNotes(t.midiNumber,e,r||60);return this.cadenceToNoteSequence(a,i)}};var G=[["I","IV","V","I"],["I","vi","IV","V"],["I","V","vi","IV"],["I","IV","vi","V"],["I","V","IV","I"],["I","IV","ii","V"],["I","ii","V","I"]],F=[["i","iv","v","i"],["i","VI","iv","v"],["i","v","VI","iv"],["i","iv","VI","v"],["i","v","iv","i"],["i","iv","ii\xB07","v"],["i","ii\xB07","v","i"]],_=[["i","iv","V","i"],["i","VI","iv","V"],["i","V","VI","iv"],["i","iv","VI","V"],["i","V","iv","i"],["i","iv","ii\xB07","V"],["i","ii\xB07","V","i"]],K=[0,2,4,5,7,9,11],q=[0,2,3,5,7,8,10],g=class{formatChordName(t,e){if(e.includes("\xB07"))return t+"dim7";if(e.includes("\xB0"))return t+"dim";let i=e.charAt(0);return i===i.toLowerCase()&&i!==i.toUpperCase()?t+"m":t}getScaleDegree(t){switch(t.replace(/Â°(7)?/g,"").toLowerCase()){case"i":return 0;case"ii":return 1;case"iii":return 2;case"iv":return 3;case"v":return 4;case"vi":return 5;case"vii":return 6;default:return 0}}getProgressionForConcreteNote(t,e,i){let r=e==="major"?K:q,a=t.map(c=>{let s=this.getScaleDegree(c),m=(i+r[s])%12,l=p[m];return this.formatChordName(l,c)}),n=this.getChordProgressionNotes(r,i);return{chordNames:a,progressionNotes:n}}getChordProgressionNotes(t,e){let i=[];for(let r of t)i.push(e+r);return i}getRandomChordProgression(t){let e=this.getChordProgressions(t),i=Math.floor(Math.random()*e.length);return e[i]}getChordProgressions(t){if(t==="major")return G;if(t==="minor_harmonic")return _;if(t==="minor_natural")return F;throw new Error(`Unsupported scale mode: ${t}`)}generateChordProgression(t,e){let i=this.getRandomChordProgression(t);return this.getProgressionForConcreteNote(i,t,e)}};var E=b,v=class{constructor(){this.rnnImprov=new mm.MusicRNN("https://storage.googleapis.com/magentadata/js/checkpoints/music_rnn/chord_pitches_improv")}init(){this.rnnImprov.initialize()}async generateDictation(t,e){let r=e,a=this.getNotesToImproviseOn(t),n={notes:a,totalTime:a.length*E},c=mm.sequences.quantizeNoteSequence(n,4),s=t.chordProgression.chordNames;return await this.rnnImprov.continueSequence(c,40,r,s)}getNotesToImproviseOn(t){let e=t.scale,i=e[e.length-1].endTime;for(let r of t.chordProgression.progressionNotes)e.push({pitch:r,startTime:i,endTime:i+E}),i+=E;return e}};var D=class{constructor(){this.player=new mm.SoundFontPlayer("https://storage.googleapis.com/magentadata/js/soundfonts/sgm_plus");try{if(mm&&mm.Player&&mm.Player.tone){let t=mm.Player.tone;this.synth=new t.Sampler({urls:{C3:"C3.mp3","D#3":"Ds3.mp3","F#3":"Fs3.mp3",A3:"A3.mp3",C4:"C4.mp3","D#4":"Ds4.mp3","F#4":"Fs4.mp3",A4:"A4.mp3",C5:"C5.mp3","D#5":"Ds5.mp3","F#5":"Fs5.mp3",A5:"A5.mp3",C6:"C6.mp3","D#6":"Ds6.mp3","F#6":"Fs6.mp3",A6:"A6.mp3"},release:1,baseUrl:"https://tonejs.github.io/audio/salamander/"}).toDestination(),this.synth.volume.value=-5}}catch(t){console.warn("Could not initialize Sampler",t)}}stop(){if(this.player.isPlaying()){this.player.stop();return}}async playCadence(t){this.stop(),await this.player.start(t)}async playDictation(t){this.currentDictation=t,this.stop(),await this.player.start(t)}async playOneNote(t){if(this.stop(),this.synth){let e=mm.Player.tone;e.context.state!=="running"&&await e.start();let i=new e.Frequency(t.pitch,"midi").toNote();this.synth.triggerAttackRelease(i,"4n")}else{let e={notes:[{pitch:t.pitch,startTime:0,endTime:.5}],totalTime:.5};this.player.start(e)}}pause(){this.player.pause()}isPlaying(){return this.player.isPlaying()}};var $=new Set(["F","Bb","Eb","Ab","Db","Gb","Cb"]);function U(o){return o==="minor_natural"||o==="minor_harmonic"}function j(o){switch(o){case"C#":return"Db";case"D#":return"Eb";case"F#":return"Gb";case"G#":return"Ab";case"A#":return"Bb";default:return o}}function z(o){let t=p.indexOf(o);if(t!==-1||(t=A.indexOf(o),t!==-1))return t;throw new Error(`Unknown note name: ${o}`)}function J(o,t){let e=o;if(U(t)){let r=(z(o)+3)%12,a=p[r];e=j(a)}return/#/.test(e)?!1:$.has(e)||/b/.test(e)}function O(o,t,e){let i=d(o,t,e),r=Math.floor(o/12)-1;return`${i}${r}`}function d(o,t,e){let i=(o%12+12)%12;return J(t,e)?A[i]:p[i]}var S=class{constructor(){this.storageKey="dictationParams"}getDictationParams(){try{let t=localStorage.getItem(this.storageKey);if(t)return JSON.parse(t)}catch(t){console.error("Error loading dictation params from localStorage",t)}return null}setDictationParams(t){try{localStorage.setItem(this.storageKey,JSON.stringify(t))}catch(e){console.error("Error saving dictation params to localStorage",e)}}};var W={major:[2,2,1,2,2,2,1],minor_natural:[2,1,2,2,1,2,2],minor_harmonic:[2,1,2,2,1,3,1]},w=class{generateScale(t){let e=W[t.type],i=[],r=t.rootNote.midiNumber,a=r,n=0,c=b;for(let s=0;s<t.octaves;s++){i.push({pitch:a,startTime:n,endTime:n+c}),n+=c;for(let m=0;m<e.length;m++)a+=e[m],i.push({pitch:a,startTime:n,endTime:n+c}),n+=c;a=r+12*(s+1)}return i}};var P=class{constructor(){this.localStorageService=new S;this.chordCadenceGenerator=new y;this.currentCadence={notes:[],totalTime:0};this.currentRevealIndex=0;this.currentNotes=[];this.isPlaying=!1;this.cadenceSpeed=.5;this.dictationPlayer=new D,this.currentDictationParams=this.localStorageService.getDictationParams()??this.getDefaultDictationParams(),this.dictationsService=new v,this.scaleGenerator=new w,this.chordProgressionService=new g,this.dictationsService.init()}getDefaultDictationParams(){return{rootNote:N.C,octaves:2,type:"major",generationTemperature:1}}getDictationParams(){return this.currentDictationParams}setDictationParams(t){this.currentDictationParams=t,this.localStorageService.setDictationParams(this.currentDictationParams)}getTargetNoteOrLast(){let t=this.currentNotes;return this.currentSample&&t&&this.currentRevealIndex<t.length?t[this.currentRevealIndex]:t[t.length-1]}hasNoteToDiscover(){return this.currentRevealIndex<this.currentNotes.length}onKeyboardNoteClick(t){let e=this.currentDictationParams,i=this.getTargetNoteOrLast();if(this.buttonsView.setPlayButtonState(!0),!i){this.dictationPlayer.playOneNote(t);return}let r=L(t.pitch,i.pitch),a;r&&this.hasNoteToDiscover()?a=i.pitch:a=48+u(t.pitch);let n={pitch:a,name:d(a,e.rootNote.name,e.type)};this.dictationPlayer.playOneNote(n),this.hasNoteToDiscover()&&(r?(this.notesDisplay.revealNoteAt(this.currentRevealIndex,i,e.rootNote,e.type),this.notesDisplay.markCorrectAt(this.currentRevealIndex),this.currentRevealIndex++,this.currentRevealIndex>=this.currentNotes.length&&this.buttonsView.setShowNoteEnabled(!1)):this.notesDisplay.markWrongAt(this.currentRevealIndex))}async prepareDictation(){this.normalizeTemperature();let t=this.generateDictationData(this.currentDictationParams);this.currentSample=await this.dictationsService.generateDictation(t,this.currentDictationParams.generationTemperature),this.currentNotes=this.currentSample.notes||[];let e=this.currentNotes?.[0]?.pitch;this.currentCadence=this.chordCadenceGenerator.generateCadence(this.currentDictationParams.rootNote,this.currentDictationParams.type,this.cadenceSpeed,e),this.currentRevealIndex=0,this.dictationParamsView.updateView(this.currentDictationParams),this.notesDisplay.renderPlaceholders(this.currentSample?.notes);let i=this.currentDictationParams.rootNote.midiNumber;this.keyboardView.renderPianoOctave(i),this.buttonsView.setActionsEnabled(!0),this.buttonsView.setShowNoteEnabled(!0)}async playCadenceWithDictation(){await this.playCadence(),await this.sleep(1e3),await this.playDictation()}normalizeTemperature(){let i=Math.max(.1,Math.min(1.5,this.currentDictationParams.generationTemperature));i!==this.currentDictationParams.generationTemperature&&(this.currentDictationParams.generationTemperature=i,this.selectorsView?.syncFromParams())}setGenerationTemperature(t){this.currentDictationParams.generationTemperature=t,this.localStorageService.setDictationParams(this.currentDictationParams)}generateDictationData(t){let e=this.scaleGenerator.generateScale(t);return{chordProgression:this.chordProgressionService.generateChordProgression(t.type,t.rootNote.midiNumber),scale:e}}sleep(t){return new Promise(e=>setTimeout(e,t))}async playDictation(){this.isPlaying?(this.isPlaying=!1,this.dictationPlayer.pause(),this.buttonsView.setPlayButtonState(!0)):this.currentSample&&(this.isPlaying=!0,this.buttonsView.setPlayButtonState(!1),await this.dictationPlayer.playDictation(this.currentSample),this.isPlaying=!1,this.buttonsView.setPlayButtonState(!0))}async playCadence(){this.currentCadence&&await this.dictationPlayer.playCadence(this.currentCadence)}getOneOctaveScale(t){return this.scaleGenerator.generateScale({...t,octaves:1}).map(i=>({pitch:i.pitch,name:d(i.pitch,this.currentDictationParams.rootNote.name,this.currentDictationParams.type)}))}initViewInteractions(t,e,i,r,a){this.notesDisplay=t,this.dictationParamsView=e,this.keyboardView=i,this.buttonsView=r,this.selectorsView=a}init(){let t=this.currentDictationParams.rootNote.midiNumber;this.keyboardView.renderPianoOctave(t)}updateKeyboard(){let t=this.currentDictationParams.rootNote.midiNumber;this.keyboardView.renderPianoOctave(t)}revealNextNote(){if(!this.currentSample||!this.currentSample.notes)return;let t=this.currentSample.notes;if(this.currentRevealIndex>=t.length){this.buttonsView.setShowNoteEnabled(!1);return}let e=this.currentRevealIndex,i=t[e];this.notesDisplay.revealNoteAt(e,i,this.currentDictationParams.rootNote,this.currentDictationParams.type),this.currentRevealIndex++,this.currentRevealIndex>=t.length&&this.buttonsView.setShowNoteEnabled(!1)}};var f=class{constructor(t){this.startBtn=document.getElementById("start"),this.playDictationBtn=document.getElementById("play-dictation"),this.playCadenceBtn=document.getElementById("play-cadence"),this.appViewModel=t,this.showNoteBtn=document.getElementById("show-note"),this.setupEventListeners()}setupEventListeners(){this.startBtn?.addEventListener("click",async()=>{try{this.setStartLoading(!0),this.setStartEnabled(!1),await new Promise(t=>setTimeout(t,0)),await this.appViewModel.prepareDictation()}finally{this.setStartLoading(!1),this.setStartEnabled(!0)}await this.appViewModel.playCadenceWithDictation()}),this.playDictationBtn?.addEventListener("click",async()=>await this.appViewModel.playDictation()),this.playCadenceBtn?.addEventListener("click",async()=>await this.appViewModel.playCadence()),this.showNoteBtn?.addEventListener("click",()=>this.appViewModel.revealNextNote())}setActionsEnabled(t){this.playDictationBtn&&(this.playDictationBtn.disabled=!t,this.playDictationBtn.setAttribute("aria-disabled",String(!t))),this.playCadenceBtn&&(this.playCadenceBtn.disabled=!t,this.playCadenceBtn.setAttribute("aria-disabled",String(!t))),this.showNoteBtn&&(this.showNoteBtn.disabled=!t,this.showNoteBtn.setAttribute("aria-disabled",String(!t)))}setStartEnabled(t){this.startBtn.disabled=!t,this.startBtn.setAttribute("aria-disabled",String(!t))}setShowNoteEnabled(t){this.showNoteBtn&&(this.showNoteBtn.disabled=!t,this.showNoteBtn.setAttribute("aria-disabled",String(!t)))}setPlayButtonState(t){let e=this.playDictationBtn.querySelector("#play-icon"),i=this.playDictationBtn.querySelector("#stop-icon"),r=this.playDictationBtn.querySelector("span");t?(e.style.display="block",i.style.display="none",r.textContent="Play dictation"):(e.style.display="none",i.style.display="block",r.textContent="Stop dictation")}setStartLoading(t){let e=this.startBtn.querySelector(".btn-text"),i=this.startBtn.querySelector("svg");t?(this.startBtn.classList.add("btn--loading"),e.textContent="Generating...",i.style.opacity="0"):(this.startBtn.classList.remove("btn--loading"),e.textContent="Start New",i.style.opacity="1")}};var M=class{constructor(){this.dictationParamsSection=document.getElementById("dictation-params-section"),this.dictationParamsDiv=document.getElementById("dictation-params")}convertType(t){switch(t){case"major":return"Major";case"minor_natural":return"Natural Minor";case"minor_harmonic":return"Harmonic Minor";default:return"Unknown"}}updateView(t){this.dictationParamsDiv&&(this.dictationParamsDiv.innerHTML=`
            <p><strong>Scale:</strong> <span>${t.rootNote.name} ${this.convertType(t.type)}</span></p>
        `,this.dictationParamsSection.style.display="block")}};var Q="keyboard",T=class{constructor(t){this.container=document.getElementById(Q),this.appViewModel=t}renderScale(t){if(this.container){this.container.innerHTML="";for(let e of t){let i=e.pitch,r=e.name,a=document.createElement("button");a.className="key-btn btn",a.type="button",a.setAttribute("data-pitch",String(i)),a.setAttribute("aria-label",`${r} (${i})`),a.textContent=r,a.addEventListener("click",()=>this.onClick({pitch:i,name:r})),this.container.appendChild(a)}}}renderPianoOctave(t){if(!this.container)return;this.container.innerHTML="";let e=this.appViewModel.getDictationParams(),i=document.createElement("div");i.className="kb-row kb-row--black";let r=document.createElement("div");r.className="kb-row kb-row--white";let a=s=>[0,2,4,5,7,9,11].includes(s),n=(t%12+12)%12;a(n)||(t=t-1);let c=[];for(let s=t;s<=t+12;s++){let m=(s%12+12)%12;if(c.length===8)break;a(m)&&c.push({pitch:s,pc:m})}c.forEach((s,m)=>{let l=this.makeKeyButton(s.pitch,e.rootNote.name,e.type,!1);l.style.gridColumn=`${m*2+1} / span 2`,r.appendChild(l)});for(let s=0;s<c.length-1;s++){let m=c[s];if(m.pc===4||m.pc===11)continue;let l=m.pitch+1;if(l>=t+12)continue;let I=this.makeKeyButton(l,e.rootNote.name,e.type,!0);I.style.gridColumn=`${s*2+2} / span 2`,i.appendChild(I)}this.container.appendChild(i),this.container.appendChild(r)}makeKeyButton(t,e,i,r){let a=d(t,e,i),n=document.createElement("button");return n.className=`key-btn btn ${r?"key--black":"key--white"}`,n.type="button",n.setAttribute("data-pitch",String(t)),n.setAttribute("aria-label",`${a} (${t})`),n.textContent=a,n.addEventListener("click",()=>this.onClick({pitch:t,name:a})),n}onClick(t){this.appViewModel.onKeyboardNoteClick(t)}};var C=class{constructor(){this.placeholdersEl=document.getElementById("placeholders")}renderPlaceholders(t){let e=Array.from({length:t.length},()=>"<li>?</li>").join("");this.placeholdersEl.innerHTML=e}revealNoteAt(t,e,i,r){let a=this.placeholdersEl.children.item(t);a.textContent=O(e.pitch,i.name,r),a.classList.remove("note--wrong"),a.classList.add("note--correct")}markCorrectAt(t){let e=this.placeholdersEl.children.item(t);e.classList.remove("note--wrong"),e.classList.add("note--correct")}markWrongAt(t){let e=this.placeholdersEl.children.item(t);e.classList.remove("note--correct"),e.classList.add("note--wrong")}};var V=class{constructor(t){this.app=t,this.rootSelect=document.getElementById("root-select"),this.scaleSelect=document.getElementById("scale-select"),this.temperatureInput=document.getElementById("generation-temperature"),this.renderOptions(),this.setupEventHandlers(),this.syncFromParams()}renderOptions(){this.rootSelect.innerHTML=R.map(e=>`<option value="${e}">${e}</option>`).join("");let t=["major","minor_natural","minor_harmonic"];this.scaleSelect.innerHTML=t.map(e=>`<option value="${e}">${this.prettyScaleLabel(e)}</option>`).join("")}prettyScaleLabel(t){switch(t){case"major":return"Major";case"minor_natural":return"Natural Minor";case"minor_harmonic":return"Harmonic Minor";default:return String(t)}}setupEventHandlers(){this.rootSelect.addEventListener("change",()=>this.applyToModel()),this.scaleSelect.addEventListener("change",()=>this.applyToModel()),this.temperatureInput.addEventListener("change",()=>this.applyToModel())}syncFromParams(){let t=this.app.getDictationParams();this.rootSelect.value=t.rootNote.name,this.scaleSelect.value=t.type,this.temperatureInput.value=String(t.generationTemperature)}applyToModel(){let t=this.app.getDictationParams(),e=this.rootSelect.value,i=this.scaleSelect.value,r={...t,rootNote:N[e],type:i};this.app.setDictationParams(r);let a=parseFloat(this.temperatureInput.value);if(!isNaN(a)){let n=Math.round(a*10)/10;this.app.setGenerationTemperature?.(n)}this.app.updateKeyboard()}};var B=class{constructor(){this.appViewModel=new P;let t=new C,e=new M,i=new T(this.appViewModel),r=new f(this.appViewModel),a=new V(this.appViewModel);this.appViewModel.initViewInteractions(t,e,i,r,a),this.appViewModel.init()}};document.addEventListener("DOMContentLoaded",()=>{new B});})();
